{% load markdown_filter %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan - Print Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gradient-start': '#667eea',
                        'gradient-end': '#764ba2'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-page {
                page-break-inside: avoid;
            }
            
            body {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .signature-section {
                page-break-inside: avoid;
                margin-top: 2rem;
            }
        }
        
        .signature-line {
            border-bottom: 2px solid #374151;
            min-height: 40px;
            margin-bottom: 8px;
        }
        
        /* Styling for markdown content */
        .lesson-content h1, .lesson-content h2, .lesson-content h3 {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #374151;
        }
        
        .lesson-content h1 { font-size: 1.5rem; }
        .lesson-content h2 { font-size: 1.25rem; }
        .lesson-content h3 { font-size: 1.125rem; }
        
        .lesson-content p {
            margin-bottom: 1rem;
            line-height: 1.625;
            color: #4b5563;
        }
        
        .lesson-content ul, .lesson-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            color: #4b5563;
        }
        
        .lesson-content li {
            margin-bottom: 0.25rem;
        }
        
        .lesson-content strong {
            font-weight: 600;
            color: #374151;
        }
        
        .lesson-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Bar (No Print) -->
    <div class="no-print bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <button onclick="goBack()" class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span>Go Back</span>
            </button>
            
            <div class="flex space-x-3">
                <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Create Another
                </a>
                <button onclick="saveAsDraft()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium shadow-lg transition-colors">
                    Save as Draft
                </button>
                <button onclick="printPage()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium shadow-lg transition-colors">
                    Print Lesson Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl print-page mt-6 mb-6">
        <!-- Header -->
        <div class="gradient-bg text-white px-8 py-6">
            <h1 class="text-2xl font-bold text-center">LESSON PLAN</h1>
            <p class="text-center text-blue-100 mt-2">Generated Lesson Plan - Ready for Review</p>
        </div>

        <!-- Dynamic Lesson Plan Content -->
        <div class="p-8">
            <!-- Django Template Integration -->
            <div class="lesson-content space-y-6">
                {% if lesson_plan %}
                    {{ lesson_plan|markdown }}
                {% else %}
                    <!-- Fallback content if no lesson plan is provided -->
                    <div class="border-b border-gray-200 pb-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">Lesson Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Subject:</label>
                                <p class="text-gray-800 font-medium">Mathematics</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Grade Level:</label>
                                <p class="text-gray-800 font-medium">Grade 5</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Duration:</label>
                                <p class="text-gray-800 font-medium">45 minutes</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Date:</label>
                                <p class="text-gray-800 font-medium">_________________</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Learning Objectives</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>Students will understand the concept of fractions</li>
                            <li>Students will be able to identify equivalent fractions</li>
                            <li>Students will solve basic fraction problems</li>
                        </ul>
                    </div>

                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Materials Needed</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>Fraction circles</li>
                            <li>Whiteboard and markers</li>
                            <li>Student worksheets</li>
                            <li>Calculator (optional)</li>
                        </ul>
                    </div>

                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Lesson Activities</h3>
                        <div class="space-y-3">
                            <div>
                                <h4 class="font-medium text-gray-800">Introduction (10 minutes)</h4>
                                <p class="text-gray-700 ml-4">Review previous lesson on whole numbers and introduce fraction concepts using visual aids.</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">Main Activity (25 minutes)</h4>
                                <p class="text-gray-700 ml-4">Hands-on practice with fraction circles, group work on identifying equivalent fractions.</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">Conclusion (10 minutes)</h4>
                                <p class="text-gray-700 ml-4">Summary of key concepts and assignment of homework problems.</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Assessment Method</h3>
                        <p class="text-gray-700">Formative assessment through observation during group work and exit ticket with three fraction problems.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Signature Section -->
        <div class="signature-section border-t border-gray-300 p-8 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 text-center">APPROVAL SIGNATURES</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <!-- Teacher Signature -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">TEACHER</label>
                        <div class="signature-line"></div>
                        <p class="text-xs text-gray-500 mt-1">Signature</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Teacher Name:</label>
                        <div class="border-b border-gray-400 pb-1 min-h-[24px]"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Date:</label>
                        <div class="border-b border-gray-400 pb-1 min-h-[24px]"></div>
                    </div>
                </div>

                <!-- Principal Signature -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">PRINCIPAL</label>
                        <div class="signature-line"></div>
                        <p class="text-xs text-gray-500 mt-1">Signature</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Principal Name:</label>
                        <div class="border-b border-gray-400 pb-1 min-h-[24px]"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Date:</label>
                        <div class="border-b border-gray-400 pb-1 min-h-[24px]"></div>
                    </div>
                </div>
            </div>

            <!-- Approval Status -->
            <div class="mt-8 text-center">
                <div class="inline-flex space-x-8">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="w-4 h-4 text-green-600 border-gray-300 rounded">
                        <span class="text-sm font-medium text-gray-700">APPROVED</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="w-4 h-4 text-red-600 border-gray-300 rounded">
                        <span class="text-sm font-medium text-gray-700">NEEDS REVISION</span>
                    </label>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-600 mb-2">Comments/Suggestions:</label>
                <div class="min-h-[80px] border border-gray-300 rounded-lg p-3 bg-white">
                    <!-- Space for handwritten comments -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-100 px-8 py-4 text-center text-xs text-gray-500">
            <p>This document requires both Teacher and Principal signatures for official approval.</p>
            <p class="mt-1">Generated on: <span id="current-date"></span></p>
        </div>
    </div>

    <script>
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString();

        // Print function
        function printPage() {
            window.print();
        }

        // Go back function
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Fallback to home page
                window.location.href = '/';
            }
        }
    // Save as draft function
    function saveAsDraft() {
        // Extract the lesson plan content
        const lessonPlanContent = document.querySelector('.lesson-content').innerHTML;
        const lessonPlanText = document.querySelector('.lesson-content').innerText;
        
        // Parse metadata from the content
        const metadata = parseMetadata(lessonPlanText);
        const procedureSections = parseProcedureSections(lessonPlanText);
        
        // Send AJAX request to save as draft
        fetch('/save-lesson-plan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                title: 'Lesson Plan - ' + new Date().toLocaleDateString(),
                subject: metadata.subject,
                grade_level: metadata.gradeLevel,
                quarter: metadata.quarter,
                duration: metadata.duration,
                population: metadata.population,
                learning_objectives: metadata.learningObjectives,
                subject_matter: metadata.subjectMatter,
                materials_needed: metadata.materialsNeeded,
                introduction: procedureSections.introduction.content,
                instruction: procedureSections.instruction.content,
                application: procedureSections.application.content,
                evaluation: procedureSections.evaluation.content,
                assessment: procedureSections.assessment.content,
                generated_content: lessonPlanContent,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Lesson plan saved as draft successfully!');
                if (data.draft_id) {
                    window.location.href = `/drafts/${data.draft_id}/edit/`;
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the draft.');
        });
    }

    function parseMetadata(text) {
        const metadata = {
            subject: "",
            gradeLevel: "",
            quarter: "",
            duration: "",
            population: "",
            learningObjectives: "",
            subjectMatter: "",
            materialsNeeded: ""
        };
        
        const lines = text.split('\n');
        let currentSection = "";
        
        for (const line of lines) {
            const trimmedLine = line.trim();
            
            if (trimmedLine.includes('Subject:')) {
                metadata.subject = trimmedLine.split('Subject:')[1]?.trim() || '';
            } else if (trimmedLine.includes('Grade Level:')) {
                metadata.gradeLevel = trimmedLine.split('Grade Level:')[1]?.trim() || '';
            } else if (trimmedLine.includes('Quarter:')) {
                metadata.quarter = trimmedLine.split('Quarter:')[1]?.trim() || '';
            } else if (trimmedLine.includes('Duration:')) {
                metadata.duration = parseInt(trimmedLine.split('Duration:')[1]?.replace('minutes', '').trim()) || 0;
            } else if (trimmedLine.includes('Class Size:')) {
                metadata.population = parseInt(trimmedLine.split('Class Size:')[1]?.replace('students', '').trim()) || 0;
            } else if (trimmedLine === 'Learning Objectives') {
                currentSection = 'objectives';
            } else if (trimmedLine === 'Subject Matter') {
                currentSection = 'subjectMatter';
            } else if (trimmedLine === 'Materials Needed') {
                currentSection = 'materials';
            } else if (currentSection === 'objectives' && trimmedLine.startsWith('*')) {
                metadata.learningObjectives += trimmedLine.replace('*', '').trim() + '\n';
            } else if (currentSection === 'subjectMatter' && trimmedLine && !trimmedLine.includes('**') && !trimmedLine.startsWith('###')) {
                metadata.subjectMatter += trimmedLine + '\n';
            } else if (currentSection === 'materials' && trimmedLine.startsWith('*')) {
                metadata.materialsNeeded += trimmedLine.replace('*', '').trim() + '\n';
            }
        }
        
        return metadata;
    }

    function parseProcedureSections(text) {
        const sections = {
            introduction: { time: '', content: '' },
            instruction: { time: '', content: '' },
            application: { time: '', content: '' },
            evaluation: { time: '', content: '' },
            assessment: { time: '', content: '' }
        };
        
        const lines = text.split('\n');
        let currentSection = '';
        
        for (const line of lines) {
            const trimmedLine = line.trim();
            
            if (trimmedLine.includes('A. Introduction')) {
                currentSection = 'introduction';
                const timeMatch = trimmedLine.match(/\(([^)]+)\)/);
                if (timeMatch) sections.introduction.time = timeMatch[1];
            } else if (trimmedLine.includes('B. Instruction/Direct Teaching')) {
                currentSection = 'instruction';
                const timeMatch = trimmedLine.match(/\(([^)]+)\)/);
                if (timeMatch) sections.instruction.time = timeMatch[1];
            } else if (trimmedLine.includes('C. Guided Practice/Application')) {
                currentSection = 'application';
                const timeMatch = trimmedLine.match(/\(([^)]+)\)/);
                if (timeMatch) sections.application.time = timeMatch[1];
            } else if (trimmedLine.includes('D. Independent Practice/Evaluation')) {
                currentSection = 'evaluation';
                const timeMatch = trimmedLine.match(/\(([^)]+)\)/);
                if (timeMatch) sections.evaluation.time = timeMatch[1];
            } else if (trimmedLine.includes('E. Assessment')) {
                currentSection = 'assessment';
                const timeMatch = trimmedLine.match(/\(([^)]+)\)/);
                if (timeMatch) sections.assessment.time = timeMatch[1];
            } else if (currentSection && trimmedLine && !trimmedLine.startsWith('###') && !trimmedLine.startsWith('##')) {
                sections[currentSection].content += trimmedLine + '\n';
            }
        }
        
        return sections;
    }
</script>
</body>
</html>