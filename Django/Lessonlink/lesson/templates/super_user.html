<!DOCTYPE html>
<html>
<head>
    <title>Super User Dashboard - School Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-navy: #1e3a5f;
            --secondary-blue: #2c5282;
            --accent-gold: #d4af37;
            --text-dark: #2d3748;
            --border-light: #e2e8f0;
            --bg-light: #f7fafc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--secondary-blue) 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
            letter-spacing: 0.3px;
        }

        .stats-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .stats-card .card-body {
            padding: 1.5rem;
        }

        .stats-card h5 {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            opacity: 0.95;
        }

        .stats-card h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0;
        }

        .bg-primary {
            background: linear-gradient(135deg, #2c5282 0%, #2b6cb0 100%) !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #ecc94b 100%) !important;
            color: #744210 !important;
        }

        .bg-success {
            background: linear-gradient(135deg, #2f855a 0%, #38a169 100%) !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, #c53030 0%, #e53e3e 100%) !important;
        }

        .page-header {
            margin: 2rem 0 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .page-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--primary-navy);
            margin: 0;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--border-light);
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #64748b;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            margin-bottom: -2px;
            background: transparent;
        }

        .nav-tabs .nav-link:hover {
            border: none;
            color: var(--secondary-blue);
            background: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-navy);
            background: transparent;
            border: none;
            border-bottom: 3px solid var(--primary-navy);
        }

        .nav-tabs .badge {
            font-weight: 500;
            padding: 0.25rem 0.5rem;
        }

        .list-group-item {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .school-item {
            border-left-width: 4px;
            border-left-style: solid;
            padding: 1.5rem;
        }

        .school-item {
            border-left-color: #d69e2e;
        }

        .school-item.approved {
            border-left-color: #38a169;
        }

        .school-item.rejected {
            border-left-color: #e53e3e;
        }

        .school-item h5 {
            color: var(--primary-navy);
            font-weight: 600;
            font-size: 1.125rem;
        }

        .school-item p {
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .school-item strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        .btn {
            font-weight: 500;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            border: none;
            transition: all 0.15s ease;
        }

        .btn-success {
            background-color: #38a169;
        }

        .btn-success:hover {
            background-color: #2f855a;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-danger {
            background-color: #e53e3e;
        }

        .btn-danger:hover {
            background-color: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-info {
            background-color: #3182ce;
            color: white;
        }

        .btn-info:hover {
            background-color: #2c5282;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--secondary-blue);
        }

        .btn-primary:hover {
            background-color: var(--primary-navy);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .card {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card-header {
            background-color: #f8fafc;
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-footer {
            background-color: #f8fafc;
            border-top: 1px solid var(--border-light);
            padding: 1rem 1.25rem;
        }

        .alert {
            border-radius: 8px;
            border: none;
            padding: 1rem 1.25rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .alert-info {
            background-color: #ebf8ff;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .alert-warning {
            background-color: #fef5e7;
            color: #744210;
            border-left: 4px solid #d69e2e;
        }

        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        .modal-header {
            background-color: var(--primary-navy);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.25rem 1.5rem;
        }

        .modal-header.bg-danger {
            background-color: #dc3545 !important;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body h6 {
            color: var(--primary-navy);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-light);
        }

        .modal-footer {
            background-color: #f8fafc;
            border-top: 1px solid var(--border-light);
            padding: 1rem 1.5rem;
        }

        .badge {
            font-weight: 500;
            padding: 0.35rem 0.65rem;
            border-radius: 4px;
        }

        .btn-group .btn {
            padding: 0.5rem 1rem;
        }

        small {
            color: #718096;
            font-size: 0.875rem;
        }

        .container {
            max-width: 1200px;
        }

        .rejection-reason {
            background-color: #fff3f3;
            border-left: 4px solid #dc3545;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Super User Dashboard</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ request.user.username }}</span>
                <a class="btn btn-outline-light btn-sm" href="{% url 'admin:index' %}">Admin Panel</a>
                <a class="btn btn-outline-light btn-sm ms-2" href="{% url 'logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Total Schools</h5>
                        <h2 class="card-text">{{ total_schools }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Pending</h5>
                        <h2 class="card-text">{{ pending_schools_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Approved</h5>
                        <h2 class="card-text">{{ approved_schools_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">Rejected</h5>
                        <h2 class="card-text">{{ rejected_schools_count }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-header">
            <h2>School Management</h2>
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Tabs for different views -->
        <ul class="nav nav-tabs mb-3" id="schoolTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                    Pending <span class="badge bg-warning">{{ pending_schools_count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                    Approved <span class="badge bg-success">{{ approved_schools_count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-admin-tab" data-bs-toggle="tab" data-bs-target="#register-admin" type="button" role="tab">
                    Register Admins <span class="badge bg-info">{{ approved_schools_count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                    Rejected <span class="badge bg-danger">{{ rejected_schools_count }}</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="schoolTabsContent">
            <!-- Pending Schools Tab -->
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                {% if pending_schools %}
                    <div class="list-group">
                        {% for school in pending_schools %}
                            <div class="list-group-item school-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ school.school_name }}</h5>
                                    <small>{{ school.created_at|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1"><strong>School ID:</strong> {{ school.school_id }}</p>
                                <p class="mb-1"><strong>Email:</strong> {{ school.email }}</p>
                                <p class="mb-1"><strong>Phone:</strong> {{ school.phone_number }}</p>
                                <p class="mb-1"><strong>Address:</strong> {{ school.address }}</p>
                                <p class="mb-1"><strong>Contact Person:</strong> {{ school.contact_person }}</p>
                                <p class="mb-1"><strong>Contact Email:</strong> {{ school.contact_email }}</p>
                                
                                <div class="mt-3">
                                    <form method="POST" action="{% url 'approve_school' school.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-sm">✓ Approve</button>
                                    </form>
                                    
                                    <!-- Reject Button with Modal Trigger -->
                                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal{{ school.id }}">
                                        ✗ Reject
                                    </button>
                                    
                                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#schoolModal{{ school.id }}">
                                        View Details
                                    </button>
                                </div>
                            </div>

                            <!-- School Details Modal -->
                            <div class="modal fade" id="schoolModal{{ school.id }}" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ school.school_name }} - Complete Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>School Information</h6>
                                                    <p><strong>School Name:</strong> {{ school.school_name }}</p>
                                                    <p><strong>School ID:</strong> {{ school.school_id }}</p>
                                                    <p><strong>Year Established:</strong> {{ school.year_established }}</p>
                                                    <p><strong>Email:</strong> {{ school.email }}</p>
                                                    <p><strong>Phone:</strong> {{ school.phone_number }}</p>
                                                    {% if school.website %}
                                                        <p><strong>Website:</strong> {{ school.website }}</p>
                                                    {% endif %}
                                                    {% if school.facebook_page %}
                                                        <p><strong>Facebook:</strong> {{ school.facebook_page }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Location</h6>
                                                    <p><strong>Address:</strong> {{ school.address }}</p>
                                                    <p><strong>Province:</strong> {{ school.province }}</p>
                                                    <p><strong>Region:</strong> {{ school.region }}</p>
                                                    
                                                    <h6 class="mt-3">Contact Person</h6>
                                                    <p><strong>Name:</strong> {{ school.contact_person }}</p>
                                                    <p><strong>Position:</strong> {{ school.position }}</p>
                                                    <p><strong>Email:</strong> {{ school.contact_email }}</p>
                                                    <p><strong>Phone:</strong> {{ school.contact_phone }}</p>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <h6>Registration Details</h6>
                                                    <p><strong>Registered:</strong> {{ school.created_at }}</p>
                                                    <p><strong>Status:</strong> <span class="badge bg-warning">{{ school.get_status_display }}</span></p>
                                                    {% if school.accuracy %}
                                                        <p><strong>✓ Information Accuracy Certified</strong></p>
                                                    {% endif %}
                                                    {% if school.terms %}
                                                        <p><strong>✓ Terms and Privacy Agreed</strong></p>
                                                    {% endif %}
                                                    {% if school.communications %}
                                                        <p><strong>✓ Communications Consent Given</strong></p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <form method="POST" action="{% url 'approve_school' school.id %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success">Approve School</button>
                                            </form>
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ school.id }}">
                                                Reject School
                                            </button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Rejection Reason Modal -->
                            <div class="modal fade" id="rejectModal{{ school.id }}" tabindex="-1" aria-labelledby="rejectModalLabel{{ school.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title" id="rejectModalLabel{{ school.id }}">Reject School Registration</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form method="POST" action="{% url 'reject_school' school.id %}">
                                            {% csrf_token %}
                                            <div class="modal-body">
                                                <p>You are about to reject <strong>{{ school.school_name }}</strong></p>
                                                <p class="text-muted mb-3">Please provide a reason for rejection. This will be included in the email sent to the contact person.</p>
                                                
                                                <div class="mb-3">
                                                    <label for="reason{{ school.id }}" class="form-label fw-bold">Rejection Reason <span class="text-danger">*</span></label>
                                                    <textarea class="form-control" id="reason{{ school.id }}" name="reason" rows="4" placeholder="Enter detailed reason for rejection..." required></textarea>
                                                </div>
                                            
                                                
                                                <div class="alert alert-warning">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    <strong>Warning:</strong> This action cannot be undone. The school will be notified via email with the reason provided above.
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">Confirm Rejection</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <h5>No pending schools for approval.</h5>
                        <p class="mb-0">All schools have been processed.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Approved Schools Tab -->
            <div class="tab-pane fade" id="approved" role="tabpanel">
                {% if approved_schools %}
                    <div class="list-group">
                        {% for school in approved_schools %}
                            <div class="list-group-item school-item approved">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ school.school_name }}</h5>
                                    <small>Approved on {{ school.updated_at|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1"><strong>School ID:</strong> {{ school.school_id }}</p>
                                <p class="mb-1"><strong>Email:</strong> {{ school.email }}</p>
                                <p class="mb-1"><strong>Phone:</strong> {{ school.phone_number }}</p>
                                <p class="mb-1"><strong>Contact:</strong> {{ school.contact_person }}</p>
                                {% if school.processed_by %}
                                    <p class="mb-1"><strong>Approved by:</strong> {{ school.processed_by.get_full_name }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">No approved schools yet.</div>
                {% endif %}
            </div>

            <!-- Register Admins Tab -->
            <div class="tab-pane fade" id="register-admin" role="tabpanel">
                {% if approved_schools %}
                    <div class="row">
                        {% for school in approved_schools %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">{{ school.school_name }}</h6>
                                        <span class="badge bg-success">Approved</span>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            <strong>School ID:</strong> {{ school.school_id }}<br>
                                            <strong>Email:</strong> {{ school.email }}<br>
                                            <strong>Contact:</strong> {{ school.contact_person }}<br>
                                            <strong>Current Admins:</strong> 
                                            <span class="badge {% if school.admins.count == 0 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ school.admins.count }}
                                            </span>
                                        </p>
                                        
                                        {% if school.admins.count == 0 %}
                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                No admin registered for this school
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer">
                                        <div class="btn-group w-100">
                                            <a href="{% url 'register_school_admin' school.id %}" 
                                               class="btn btn-primary btn-sm">
                                                Register Admin
                                            </a>
                                            <a href="{% url 'school_admin_list' school.id %}" 
                                               class="btn btn-info btn-sm">
                                                View Admins
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <h5>No approved schools available</h5>
                        <p class="mb-0">Approve some schools first to register admins for them.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Rejected Schools Tab -->
            <div class="tab-pane fade" id="rejected" role="tabpanel">
                {% if rejected_schools %}
                    <div class="list-group">
                        {% for school in rejected_schools %}
                            <div class="list-group-item school-item rejected">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ school.school_name }}</h5>
                                    <small>Rejected on {{ school.updated_at|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1"><strong>School ID:</strong> {{ school.school_id }}</p>
                                <p class="mb-1"><strong>Email:</strong> {{ school.email }}</p>
                                <p class="mb-1"><strong>Phone:</strong> {{ school.phone_number }}</p>
                                {% if school.admin_notes %}
                                    <div class="rejection-reason">
                                        <strong>Rejection Reason:</strong> {{ school.admin_notes }}
                                    </div>
                                {% endif %}
                                {% if school.processed_by %}
                                    <p class="mb-1"><strong>Rejected by:</strong> {{ school.processed_by.get_full_name }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">No rejected schools.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // Optional: Add validation to ensure reason is provided
        document.addEventListener('DOMContentLoaded', function() {
            var rejectForms = document.querySelectorAll('form[action*="reject_school"]');
            rejectForms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    var reasonField = form.querySelector('textarea[name="reason"]');
                    if (reasonField && !reasonField.value.trim()) {
                        e.preventDefault();
                        alert('Please provide a rejection reason.');
                    }
                });
            });
        });
    </script>
</body>
</html>