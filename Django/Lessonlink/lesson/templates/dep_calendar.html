<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LessonLink - Department Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .lesson-card {
            transition: all 0.3s ease;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: linear-gradient(135deg, #d1fae5 0%, #34d399 100%);
            color: #065f46;
        }

        .status-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #f87171 100%);
            color: #991b1b;
        }

        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
            border-color: #d1d5db;
        }

        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background-color: #eff6ff;
            border-color: #3b82f6;
            position: relative;
        }

        .calendar-day.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, #11468F, #9E5EFF);
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        .admin-activity {
            border-left: 3px solid #ef4444 !important;
        }

        .department-activity {
            border-left: 3px solid #3b82f6 !important;
        }

        .teacher-activity {
            border-left: 3px solid #10b981 !important;
        }

        /* NEW: Styles for Zamboanga external events */
        .zamboanga-activity {
            border-left: 3px solid #8b5cf6 !important;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
        }

        .zamboanga-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header - Fixed at top -->
    <header class="bg-white shadow-sm border-b fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center justify-between px-4 py-3 md:px-6 md:py-4">
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn"
                class="md:hidden p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors">
                <i class="fas fa-bars text-lg"></i>
            </button>

            <!-- Logo -->
            <div class="flex items-center space-x-3 flex-1 md:flex-none">
                <div class="w-10 h-10 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] rounded-full shadow-md"></div>
                <div class="hidden sm:block">
                    <h1 class="text-xl font-bold text-gray-900">LessonLink</h1>
                    <p class="text-sm text-gray-500 hidden lg:block">Western Mindanao State University</p>
                </div>
            </div>

            <!-- Right side actions -->
            <div class="flex items-center space-x-2 md:space-x-4">
                <!-- Search -->
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Search activities..."
                        class="w-64 px-4 py-2 bg-gray-50 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Mobile search button -->
                <button class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-search text-lg"></i>
                </button>

                <!-- Notifications -->
                <div class="relative">
                    <button id="notification-btn"
                        class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                    </button>
                </div>

                <!-- Profile -->
                <div class="relative">
                    <button id="profile-btn"
                        class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors">
                        <i class="fas fa-user text-gray-500"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Sidebar - Fixed and sticky -->
        <aside id="sidebar" class="w-64 bg-white shadow-lg h-screen fixed top-16 left-0 -translate-x-full md:translate-x-0 sidebar-transition z-30">
    <nav class="p-4 pt-8 space-y-2">
        <!-- Create Lesson Button -->
        <a href="{% url 'lesson_ai' %}" class="w-full flex items-center space-x-3 px-4 py-3 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] shadow-md transition-all">
            <i class="fas fa-plus text-lg"></i>
            <span class="font-medium">Create Lesson</span>
        </a>

        <!-- Role-based Navigation -->
        {% if user_role == 'admin' %}
            <!-- Admin Links -->
            <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-home text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="{% url 'admin_user_management' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-chalkboard-teacher text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">User Management</span>
            </a>
            <a href="{% url 'admin_system_reports' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-chart-bar text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Reports & Analytics</span>
            </a>
            <!-- <a href="{% url 'Dep_Pending' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-file-alt text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Pending Reviews</span>
                {% if pending_submissions > 0 %}
                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ pending_submissions }}</span>
                {% endif %}
            </a> -->

        {% elif user_role == 'department_head' %}
            <!-- Department Head Links -->
            <a href="{% url 'Dep_Dash' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-home text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="{% url 'department_head_drafts' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-file-alt text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">My Lesson Plans</span>
            </a>
            <a href="{% url 'Dep_Pending' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-clock text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Pending Reviews</span>
                {% if pending_submissions > 0 %}
                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ pending_submissions }}</span>
                {% endif %}
            </a>
            <a href="{% url 'Dep_Faculty' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-users text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Faculty</span>
            </a>

        {% else %}
            <!-- Teacher Links -->
            <a href="{% url 'dashboard' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-home text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="{% url 'draft_list' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-file-alt text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Drafts</span>
            </a>
            <a href="{% url 'task' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-tasks text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Tasks</span>
            </a>
            <a href="{% url 'schedule' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-clock text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Schedule</span>
            </a>
        {% endif %}

        <!-- Calendar Link (Active - Common for all roles) -->
        {% if user_role == 'admin' %}
            <a href="{% url 'admin_calendar' %}" class="flex items-center space-x-3 px-4 py-3 text-[#11468F] bg-[#f0f5ff] rounded-lg border border-[#d6e0ff]">
                <i class="fas fa-calendar-alt text-lg w-5"></i>
                <span class="font-medium">Calendar</span>
            </a>
        {% elif user_role == 'department_head' %}
            <a href="{% url 'dep_calendar' %}" class="flex items-center space-x-3 px-4 py-3 text-[#11468F] bg-[#f0f5ff] rounded-lg border border-[#d6e0ff]">
                <i class="fas fa-calendar-alt text-lg w-5"></i>
                <span class="font-medium">Calendar</span>
            </a>
        {% else %}
            <a href="#" class="flex items-center space-x-3 px-4 py-3 text-[#11468F] bg-[#f0f5ff] rounded-lg border border-[#d6e0ff]">
                <i class="fas fa-calendar-alt text-lg w-5"></i>
                <span class="font-medium">Calendar</span>
            </a>
        {% endif %}

        <!-- Common Links for All Roles (Only with working URLs) -->
        <!-- <div class="pt-4 border-t border-gray-200">
            <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                <i class="fas fa-user text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                <span class="font-medium">Profile</span>
            </a>
            <a href="{% url 'logout' %}" class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors group">
                <i class="fas fa-sign-out-alt text-lg w-5"></i>
                <span class="font-medium">Logout</span>
            </a>
        </div> -->
    </nav>
</aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-72 p-6">
            <!-- Calendar Header -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">
                            {% if user_role == 'admin' %}
                                University Calendar
                            {% elif user_role == 'department_head' %}
                                Department Calendar
                            {% else %}
                                Calendar View
                            {% endif %}
                        </h2>
                        <p class="text-gray-600">
                            {% if user_role == 'admin' %}
                                Manage university-wide activities and events
                            {% elif user_role == 'department_head' %}
                                Manage department activities (Cannot edit admin activities)
                            {% else %}
                                View department activities (Read Only)
                            {% endif %}
                        </p>
                        <!-- NEW: Zamboanga Events Info -->
                        <p class="text-sm text-purple-600 mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            Zamboanga City events are now included in the calendar
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Month Navigation -->
                        <div class="flex items-center space-x-2">
                            <button id="prev-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="current-month" class="text-xl font-semibold text-gray-900 min-w-[200px] text-center">
                                December 2024
                            </h3>
                            <button id="next-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Add Activity Button - Only show for admin and department_head -->
                        {% if user_role == 'admin' or user_role == 'department_head' %}
                        <button id="add-activity-btn-header"
                            class="px-4 py-2 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all font-medium shadow-md">
                            <i class="fas fa-plus mr-2"></i>Add Activity
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <!-- Days of Week Header -->
                    <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                        <div class="p-4 text-center font-semibold text-gray-700">Sunday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Monday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Tuesday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Wednesday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Thursday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Friday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Saturday</div>
                    </div>

                    <!-- Calendar Days Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7">
                        <!-- Calendar days will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Upcoming Activities -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Upcoming Activities</h3>
                    <!-- Add Activity Button - Only show for admin and department_head -->
                    {% if user_role == 'admin' or user_role == 'department_head' %}
                    <button id="add-activity-btn-secondary"
                        class="px-4 py-2 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all text-sm font-medium">
                        <i class="fas fa-plus mr-2"></i>Add Activity
                    </button>
                    {% endif %}
                </div>
                <div id="upcoming-activities" class="space-y-3">
                    <!-- Activities will be populated by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Overlay for mobile -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>
    </div>

    <!-- Add Activity Modal - Only include for admin and department_head -->
    {% if user_role == 'admin' or user_role == 'department_head' %}
    <div id="add-activity-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Add New Activity</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
                
                <form id="activity-form" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Activity Title</label>
                        <input type="text" id="activity-title" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="activity-description" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="activity-start-date" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="date" id="activity-end-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="activity-category" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Select Category</option>
                            <option value="academic">Academic</option>
                            <option value="examination">Examination</option>
                            <option value="meeting">Meeting</option>
                            <option value="event">Event</option>
                            <option value="deadline">Deadline</option>
                            <option value="training">Training</option>
                            <option value="holiday">Holiday</option>
                            <option value="enrollment">Enrollment</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-3 pt-4">
                        <button type="submit"
                            class="flex-1 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white px-4 py-2 rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all">
                            Add Activity
                        </button>
                        <button type="button" id="cancel-activity"
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

<script>
    // Calendar functionality - Dynamic permissions based on user role
    let currentDate = new Date();
    let activities = [];
    
    // Normalize user role to lowercase and trim whitespace for consistent comparison
    const userRole = "{{ user_role }}".toLowerCase().trim();
    const currentUserName = "{{ user.first_name }} {{ user.last_name }}";
    const currentUserId = {{ user.id }};
    
    // Debug log to check role
    console.log("Current user role:", userRole);
    console.log("Current user ID:", currentUserId);

    const categoryColors = {
        academic: '#3b82f6',
        examination: '#ef4444',
        holiday: '#10b981',
        meeting: '#f59e0b',
        event: '#8b5cf6',
        deadline: '#f97316',
        enrollment: '#06b6d4',
        training: '#ec4899',
        // NEW: Zamboanga event categories
        festival: '#8b5cf6',
        cultural: '#ec4899'
    };

    // Function to check if user can edit this activity
    function canUserEditActivity(activity) {
        console.log("Checking edit permission for activity:", activity.id, "User role:", userRole);
        
        // NEW: External Zamboanga events cannot be edited by anyone
        if (activity.isExternal) {
            console.log("External Zamboanga event - cannot edit");
            return false;
        }
        
        // Normalize role checking - compare lowercase
        const isAdmin = userRole === 'admin';
        const isDepartmentHead = userRole === 'department_head';
        const isTeacher = userRole === 'teacher';
        const isStudentTeacher = userRole === 'student_teacher';
        
        if (isAdmin) {
            console.log("User is admin - can edit");
            return true; // Admin can edit everything
        } else if (isDepartmentHead) {
            // Department heads can only edit their own activities AND cannot edit admin activities
            const isAdminActivity = activity.user && activity.user.is_superuser;
            const isOwnActivity = activity.user && activity.user.id === currentUserId;
            
            console.log("Department head check - Own activity:", isOwnActivity, "Admin activity:", isAdminActivity);
            return isOwnActivity && !isAdminActivity;
        } else if (isTeacher || isStudentTeacher) {
            console.log("User is teacher/student teacher - cannot edit");
            return false; // Teachers and Student Teachers cannot edit anything (read-only)
        } else {
            console.log("Unknown role - cannot edit");
            return false; // Default: cannot edit
        }
    }

    // Function to check if user can add activities
    function canUserAddActivities() {
        const isTeacher = userRole === 'teacher';
        const isStudentTeacher = userRole === 'student_teacher';
        
        const canAdd = !isTeacher && !isStudentTeacher;
        console.log("Can user add activities:", canAdd);
        return canAdd; // Only Admin and Department Head can add activities
    }

    // Load activities from database via AJAX
    async function loadActivities() {
        try {
            const response = await fetch("/calendar-api/activities/");
            if (response.ok) {
                activities = await response.json();
                console.log("Loaded activities:", activities.length);
                console.log("Activities breakdown:", {
                    total: activities.length,
                    local: activities.filter(a => !a.isExternal).length,
                    zamboanga: activities.filter(a => a.isExternal).length
                });
            } else {
                console.error('Failed to load activities');
                activities = [];
            }
        } catch (error) {
            console.error('Error loading activities:', error);
            activities = [];
        }
        renderCalendar();
        renderUpcomingActivities();
    }

    // Save activity to database via AJAX
    async function saveActivity(activityData) {
        try {
            const response = await fetch("/calendar-api/activities/add/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(activityData)
            });

            const responseText = await response.text();
            
            // Check if response is HTML (error page)
            if (responseText.trim().startsWith('<!DOCTYPE') || responseText.includes('<html')) {
                throw new Error('Server returned HTML page instead of JSON. Check authentication and CSRF.');
            }
            
            // Try to parse as JSON
            const result = JSON.parse(responseText);
            
            if (response.ok) {
                await loadActivities();
                return true;
            } else {
                throw new Error(result.error || 'Failed to save activity');
            }
        } catch (error) {
            console.error('Error saving activity:', error);
            alert('Error saving activity: ' + error.message);
            return false;
        }
    }

    // Delete activity from database via AJAX
    async function deleteActivity(activityId) {
        try {
            // NEW: Check if this is an external Zamboanga event
            const activity = activities.find(a => a.id === activityId);
            if (activity && activity.isExternal) {
                alert('Cannot delete Zamboanga events. These are external events.');
                return false;
            }

            const response = await fetch(`/calendar-api/activities/delete/${activityId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            const responseText = await response.text();
            
            // Check if response is HTML (error page)
            if (responseText.trim().startsWith('<!DOCTYPE') || responseText.includes('<html')) {
                throw new Error('Server returned HTML page instead of JSON. Check authentication and CSRF.');
            }
            
            // Try to parse as JSON
            const result = JSON.parse(responseText);
            
            if (response.ok) {
                await loadActivities();
                return true;
            } else {
                throw new Error(result.error || 'Failed to delete activity');
            }
        } catch (error) {
            console.error('Error deleting activity:', error);
            alert('Error deleting activity: ' + error.message);
            return false;
        }
    }

    // Get CSRF token from cookies
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Update month display
        document.getElementById('current-month').textContent = 
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        
        // Previous month days
        const prevMonth = new Date(year, month - 1, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = prevMonth - i;
            const dayElement = createDayElement(day, true, false);
            calendarGrid.appendChild(dayElement);
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = today.getDate() === day && 
                           today.getMonth() === month && 
                           today.getFullYear() === year;
            const dayElement = createDayElement(day, false, isToday);
            calendarGrid.appendChild(dayElement);
        }
        
        // Next month days to fill grid
        const totalCells = calendarGrid.children.length;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            const dayElement = createDayElement(day, true, false);
            calendarGrid.appendChild(dayElement);
        }
    }
    
    function createDayElement(day, isOtherMonth, isToday) {
        const dayElement = document.createElement('div');
        dayElement.className = `calendar-day p-2 ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
        
        const dateStr = isOtherMonth ? '' : 
            `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        dayElement.innerHTML = `
            <div class="font-medium text-sm mb-1">${day}</div>
            <div class="space-y-1" id="activities-${dateStr}">
                ${!isOtherMonth ? renderDayActivities(dateStr) : ''}
            </div>
        `;
        
        // Only allow clicking on days if user can add activities
        if (!isOtherMonth && canUserAddActivities()) {
            dayElement.addEventListener('click', () => openAddActivityModal(dateStr));
        }
        
        return dayElement;
    }
    
    function renderDayActivities(dateStr) {
        const dayActivities = activities.filter(activity => {
            const start = new Date(activity.startDate);
            const end = new Date(activity.endDate || activity.startDate);
            const current = new Date(dateStr);
            return current >= start && current <= end;
        });
        
        return dayActivities.map(activity => {
            const canEdit = canUserEditActivity(activity);
            const canDelete = canUserEditActivity(activity);
            const isAdminActivity = activity.user && activity.user.is_superuser;
            const isCurrentUserActivity = activity.user && activity.user.id === currentUserId;
            const isExternalActivity = activity.isExternal;
            
            // SIMPLIFIED: No teacher labels, just show admin and external badges
            let activityClass = 'department-activity';
            if (isAdminActivity) {
                activityClass = 'admin-activity';
            }
            if (isExternalActivity) {
                activityClass = 'zamboanga-activity';
            }
            
            return `
            <div class="group relative text-xs p-1 rounded bg-opacity-20 text-gray-700 hover:bg-opacity-30 transition-all cursor-pointer ${activityClass}" 
                 style="background-color: ${categoryColors[activity.category]}20;"
                 title="${activity.title}${activity.description ? '\n' + activity.description : ''}\nCreated by: ${activity.author || 'Unknown'}${isExternalActivity ? '\n📍 Zamboanga City Event' : ''}"
                 onclick="${canEdit ? `editActivity(${activity.id})` : ''}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <span class="activity-dot flex-shrink-0" style="background-color: ${categoryColors[activity.category]}"></span>
                        <span class="truncate">${activity.title}</span>
                        ${isAdminActivity ? '<span class="ml-1 text-red-500 text-xs">(Admin)</span>' : ''}
                        ${isExternalActivity ? '<span class="zamboanga-badge">ZC</span>' : ''}
                    </div>
                    ${canDelete && !isExternalActivity ? `
                    <button onclick="removeActivity(event, ${activity.id})" 
                        class="opacity-0 group-hover:opacity-100 ml-1 p-0.5 text-red-500 hover:text-red-700 transition-all"
                        title="Remove activity">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
            `;
        }).join('');
    }
    
    function renderUpcomingActivities() {
        const today = new Date();
        const upcoming = activities
            .filter(activity => new Date(activity.startDate) >= today)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate))
            .slice(0, 5);
        
        const container = document.getElementById('upcoming-activities');
        
        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-calendar-times text-3xl mb-3"></i>
                    <p>No upcoming activities</p>
                    ${canUserAddActivities() ? `
                    <button onclick="openAddActivityModal()" class="mt-3 text-purple-600 hover:text-purple-700 font-medium">
                        Add your first activity
                    </button>
                    ` : ''}
                </div>
            `;
            return;
        }
        
        container.innerHTML = upcoming.map(activity => {
            const canEdit = canUserEditActivity(activity);
            const canDelete = canUserEditActivity(activity);
            const isAdminActivity = activity.user && activity.user.is_superuser;
            const isCurrentUserActivity = activity.user && activity.user.id === currentUserId;
            const isExternalActivity = activity.isExternal;
            
            return `
            <div class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors ${isExternalActivity ? 'zamboanga-activity' : ''}">
                <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${categoryColors[activity.category]}"></div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 truncate">
                        ${activity.title}
                        ${isAdminActivity ? '<span class="text-red-500 text-xs ml-1">(Admin)</span>' : ''}
                        ${isExternalActivity ? '<span class="zamboanga-badge">Zamboanga City</span>' : ''}
                    </h4>
                    <p class="text-sm text-gray-600 truncate">${activity.description || 'No description'}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ${new Date(activity.startDate).toLocaleDateString()}
                        ${activity.endDate && activity.endDate !== activity.startDate ? 
                            ` - ${new Date(activity.endDate).toLocaleDateString()}` : ''}
                        <br>
                        <small>By: ${activity.author || 'Unknown'}</small>
                    </p>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <div class="text-xs bg-gray-100 px-2 py-1 rounded-full capitalize">
                        ${activity.category}
                    </div>
                    ${canDelete && !isExternalActivity ? `
                    <button onclick="removeActivity(event, ${activity.id})" 
                        class="p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                        title="Remove activity">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
            `;
        }).join('');
    }
    
    function openAddActivityModal(date = '') {
        const modal = document.getElementById('add-activity-modal');
        if (modal) {
            modal.classList.remove('hidden');
            
            if (date) {
                document.getElementById('activity-start-date').value = date;
                document.getElementById('activity-end-date').value = date;
            }
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('activity-start-date').min = today;
            document.getElementById('activity-end-date').min = today;
        }
    }
    
    function closeModal() {
        const modal = document.getElementById('add-activity-modal');
        if (modal) {
            modal.classList.add('hidden');
            document.getElementById('activity-form').reset();
        }
    }
    
    function editActivity(activityId) {
        // For now, just open the add modal - you can implement proper edit later
        const activity = activities.find(a => a.id === activityId);
        if (activity && !activity.isExternal) {
            openAddActivityModal();
            // Pre-fill form with activity data for editing
            document.getElementById('activity-title').value = activity.title;
            document.getElementById('activity-description').value = activity.description || '';
            document.getElementById('activity-start-date').value = activity.startDate;
            document.getElementById('activity-end-date').value = activity.endDate || activity.startDate;
            document.getElementById('activity-category').value = activity.category;
        }
    }
    
    async function removeActivity(event, activityId) {
        event.stopPropagation();
        
        const activity = activities.find(a => a.id === activityId);
        if (!activity) return;
        
        // NEW: Prevent deletion of Zamboanga events
        if (activity.isExternal) {
            alert('Cannot delete Zamboanga events. These are external events from Zamboanga City.');
            return;
        }
        
        if (!canUserEditActivity(activity)) {
            alert('You are not authorized to delete this activity.');
            return;
        }
        
        if (confirm('Are you sure you want to remove this activity?')) {
            const success = await deleteActivity(activityId);
            if (success) {
                // Calendar will be reloaded via the loadActivities() call in deleteActivity
            }
        }
    }
    
    // Event listeners
    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    // Only add event listeners if buttons exist (for teachers, buttons are hidden)
    const addActivityBtnSecondary = document.getElementById('add-activity-btn-secondary');
    if (addActivityBtnSecondary) {
        addActivityBtnSecondary.addEventListener('click', () => {
            openAddActivityModal();
        });
    }
    
    const addActivityBtnHeader = document.getElementById('add-activity-btn-header');
    if (addActivityBtnHeader) {
        addActivityBtnHeader.addEventListener('click', () => {
            openAddActivityModal();
        });
    }
    
    const closeModalBtn = document.getElementById('close-modal');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    
    const cancelActivityBtn = document.getElementById('cancel-activity');
    if (cancelActivityBtn) {
        cancelActivityBtn.addEventListener('click', closeModal);
    }
    
    const activityForm = document.getElementById('activity-form');
    if (activityForm) {
        activityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newActivity = {
                title: document.getElementById('activity-title').value,
                description: document.getElementById('activity-description').value,
                startDate: document.getElementById('activity-start-date').value,
                endDate: document.getElementById('activity-end-date').value || document.getElementById('activity-start-date').value,
                category: document.getElementById('activity-category').value
            };
            
            // Validate end date is not before start date
            if (newActivity.endDate && newActivity.endDate < newActivity.startDate) {
                alert('End date cannot be before start date.');
                return;
            }
            
            const success = await saveActivity(newActivity);
            if (success) {
                closeModal();
            }
        });
    }
    
    // Mobile menu toggle
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    });
    
    document.getElementById('overlay').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.add('-translate-x-full');
        }
        const overlay = document.getElementById('overlay');
        if (overlay) {
            overlay.classList.add('hidden');
        }
    });

        // DEBUG FUNCTION - Add this to test Zamboanga events
    async function debugZamboangaEvents() {
        try {
            console.log("=== DEBUG ZAMBOANGA EVENTS ===");
            const response = await fetch("/calendar-api/activities/");
            const data = await response.json();
            
            console.log("API Response:", data);
            console.log("Total activities:", data.length);
            
            const localEvents = data.filter(a => !a.isExternal);
            const zamboangaEvents = data.filter(a => a.isExternal);
            
            console.log("Local events:", localEvents.length);
            console.log("Zamboanga events:", zamboangaEvents.length);
            console.log("Zamboanga event titles:", zamboangaEvents.map(e => e.title));
            
            if (zamboangaEvents.length === 0) {
                console.log("❌ NO ZAMBOANGA EVENTS FOUND");
                console.log("Check if services.py is properly imported in views.py");
            } else {
                console.log("✅ ZAMBOANGA EVENTS ARE LOADING CORRECTLY");
            }
            
        } catch (error) {
            console.error("Debug error:", error);
        }
    }
    
    // Call debug function after page loads
    setTimeout(debugZamboangaEvents, 2000);
    
    // Initialize calendar
    loadActivities();
    
    // Initialize calendar
    loadActivities();
</script>
</body>
</html>