<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LessonLink - Admin Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
            border-color: #d1d5db;
        }

        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background-color: #eff6ff;
            border-color: #3b82f6;
            position: relative;
        }

        .calendar-day.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, #11468F, #9E5EFF);
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header - Fixed at top -->
    <header class="bg-white shadow-sm border-b fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center justify-between px-4 py-3 md:px-6 md:py-4">
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn"
                class="md:hidden p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors">
                <i class="fas fa-bars text-lg"></i>
            </button>

            <!-- Logo -->
            <div class="flex items-center space-x-3 flex-1 md:flex-none">
                <div class="w-10 h-10 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] rounded-full shadow-md"></div>
                <div class="hidden sm:block">
                    <h1 class="text-xl font-bold text-gray-900">LessonLink</h1>
                    <p class="text-sm text-gray-500 hidden lg:block">Western Mindanao State University</p>
                </div>
            </div>

            <!-- Right side actions -->
            <div class="flex items-center space-x-2 md:space-x-4">
                <!-- Search -->
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Search activities..."
                        class="w-64 px-4 py-2 bg-gray-50 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Mobile search button -->
                <button class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-search text-lg"></i>
                </button>

                <!-- Notifications -->
                <div class="relative">
                    <button id="notification-btn"
                        class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                    </button>
                </div>

                <!-- Profile -->
                <div class="relative">
                    <button id="profile-btn"
                        class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors">
                        <i class="fas fa-user text-gray-500"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Sidebar - Fixed and sticky -->
        <aside id="sidebar"
            class="w-64 bg-white shadow-lg h-screen fixed top-16 left-0 -translate-x-full md:translate-x-0 sidebar-transition z-30">
            <nav class="p-4 space-y-2">
                <!-- Quick Actions Button -->
                <button id="add-activity-btn"
                    class="w-full flex items-center space-x-3 px-4 py-3 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all shadow-md">
                    <i class="fas fa-plus text-lg"></i>
                    <span class="font-medium">Add Activity</span>
                </button>

                <!-- Navigation Items -->
                <a href="{% url 'Dep_Dash' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                    <i class="fas fa-home text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#"
                    class="flex items-center space-x-3 px-4 py-3 text-[#11468F] bg-[#f0f5ff] rounded-lg border border-[#d6e0ff]">
                    <i class="fas fa-calendar text-lg w-5"></i>
                    <span class="font-medium">Calendar</span>
                </a>
                <a href="{% url 'Dep_Pending' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                    <i class="fas fa-clock text-lg w-5 group-hover:text-primary transition-colors"></i>
                    <span>Pending Reviews</span>
                </a>
                <a href="{% url 'Dep_Faculty' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group">
                    <i class="fas fa-users text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Faculty</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-6">
            <!-- Calendar Header -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Academic Calendar</h2>
                        <p class="text-gray-600">Manage academic activities and events</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Month Navigation -->
                        <div class="flex items-center space-x-2">
                            <button id="prev-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="current-month" class="text-xl font-semibold text-gray-900 min-w-[200px] text-center">
                                December 2024
                            </h3>
                            <button id="next-month" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Add Activity Button -->
                        <button id="add-activity-btn-header"
                            class="px-4 py-2 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all font-medium shadow-md">
                            <i class="fas fa-plus mr-2"></i>Add Activity
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <!-- Days of Week Header -->
                    <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                        <div class="p-4 text-center font-semibold text-gray-700">Sunday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Monday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Tuesday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Wednesday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Thursday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Friday</div>
                        <div class="p-4 text-center font-semibold text-gray-700">Saturday</div>
                    </div>

                    <!-- Calendar Days Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7">
                        <!-- Calendar days will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Upcoming Activities -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Upcoming Activities</h3>
                    <button id="add-activity-btn-secondary"
                        class="px-4 py-2 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all text-sm font-medium">
                        <i class="fas fa-plus mr-2"></i>Add Activity
                    </button>
                </div>
                <div id="upcoming-activities" class="space-y-3">
                    <!-- Activities will be populated by JavaScript -->
                </div>
            </div>
        </main>

        <!-- Overlay for mobile -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>
    </div>

    <!-- Add Activity Modal -->
    <div id="add-activity-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Add New Activity</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
                
                <form id="activity-form" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Activity Title</label>
                        <input type="text" id="activity-title" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="activity-description" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="activity-start-date" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="date" id="activity-end-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="activity-category" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Select Category</option>
                            <option value="academic">Academic</option>
                            <option value="examination">Examination</option>
                            <option value="holiday">Holiday</option>
                            <option value="meeting">Meeting</option>
                            <option value="event">Event</option>
                            <option value="deadline">Deadline</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-3 pt-4">
                        <button type="submit"
                            class="flex-1 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white px-4 py-2 rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all">
                            Add Activity
                        </button>
                        <button type="button" id="cancel-activity"
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    // Calendar functionality - USING DATABASE (User-specific)
    let currentDate = new Date();
    let activities = [];

    const categoryColors = {
        academic: '#3b82f6',
        examination: '#ef4444',
        holiday: '#10b981',
        meeting: '#f59e0b',
        event: '#8b5cf6',
        deadline: '#f97316'
    };

    // Load activities from database via AJAX
    async function loadActivities() {
        try {
            const response = await fetch("{% url 'lessonlinkCalendar:get_calendar_activities' %}");
            if (response.ok) {
                activities = await response.json();
            } else {
                console.error('Failed to load activities');
                activities = [];
            }
        } catch (error) {
            console.error('Error loading activities:', error);
            activities = [];
        }
        renderCalendar();
        renderUpcomingActivities();
    }

    // Save activity to database via AJAX
    async function saveActivity(activityData) {
        try {
            const response = await fetch("{% url 'lessonlinkCalendar:add_calendar_activity' %}",  {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(activityData)
            });

            if (response.ok) {
                const result = await response.json();
                activityData.id = result.id;
                activities.push(activityData);
                return true;
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save activity');
            }
        } catch (error) {
            console.error('Error saving activity:', error);
            alert('Error saving activity: ' + error.message);
            return false;
        }
    }

    // Delete activity from database via AJAX
    async function deleteActivity(activityId) {
        try {
            const response = await fetch(`{% url 'lessonlinkCalendar:delete_calendar_activity' 0 %}`.replace('0', activityId), {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.ok) {
                activities = activities.filter(activity => activity.id !== activityId);
                return true;
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete activity');
            }
        } catch (error) {
            console.error('Error deleting activity:', error);
            alert('Error deleting activity: ' + error.message);
            return false;
        }
    }

    // Get CSRF token from cookies
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Keep all your existing rendering functions (they remain the same)
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Update month display
        document.getElementById('current-month').textContent = 
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        
        // Previous month days
        const prevMonth = new Date(year, month - 1, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = prevMonth - i;
            const dayElement = createDayElement(day, true, false);
            calendarGrid.appendChild(dayElement);
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = today.getDate() === day && 
                           today.getMonth() === month && 
                           today.getFullYear() === year;
            const dayElement = createDayElement(day, false, isToday);
            calendarGrid.appendChild(dayElement);
        }
        
        // Next month days to fill grid
        const totalCells = calendarGrid.children.length;
        const remainingCells = 42 - totalCells; // 6 rows × 7 days
        for (let day = 1; day <= remainingCells; day++) {
            const dayElement = createDayElement(day, true, false);
            calendarGrid.appendChild(dayElement);
        }
    }
    
    function createDayElement(day, isOtherMonth, isToday) {
        const dayElement = document.createElement('div');
        dayElement.className = `calendar-day p-2 cursor-pointer ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
        
        const dateStr = isOtherMonth ? '' : 
            `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        dayElement.innerHTML = `
            <div class="font-medium text-sm mb-1">${day}</div>
            <div class="space-y-1" id="activities-${dateStr}">
                ${!isOtherMonth ? renderDayActivities(dateStr) : ''}
            </div>
        `;
        
        if (!isOtherMonth) {
            dayElement.addEventListener('click', () => openAddActivityModal(dateStr));
        }
        
        return dayElement;
    }
    
    function renderDayActivities(dateStr) {
        const dayActivities = activities.filter(activity => {
            const start = new Date(activity.startDate);
            const end = new Date(activity.endDate || activity.startDate);
            const current = new Date(dateStr);
            return current >= start && current <= end;
        });
        
        return dayActivities.map(activity => `
            <div class="group relative text-xs p-1 rounded bg-opacity-20 text-gray-700 hover:bg-opacity-30 transition-all cursor-pointer" 
                 style="background-color: ${categoryColors[activity.category]}20; border-left: 3px solid ${categoryColors[activity.category]}"
                 title="${activity.title}${activity.description ? '\n' + activity.description : ''}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <span class="activity-dot flex-shrink-0" style="background-color: ${categoryColors[activity.category]}"></span>
                        <span class="truncate">${activity.title}</span>
                    </div>
                    <button onclick="removeActivity(${activity.id})" 
                        class="opacity-0 group-hover:opacity-100 ml-1 p-0.5 text-red-500 hover:text-red-700 transition-all"
                        title="Remove activity">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function renderUpcomingActivities() {
        const today = new Date();
        const upcoming = activities
            .filter(activity => new Date(activity.startDate) >= today)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate))
            .slice(0, 5);
        
        const container = document.getElementById('upcoming-activities');
        
        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-calendar-times text-3xl mb-3"></i>
                    <p>No upcoming activities</p>
                    <button onclick="openAddActivityModal()" class="mt-3 text-purple-600 hover:text-purple-700 font-medium">
                        Add your first activity
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = upcoming.map(activity => `
            <div class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors">
                <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${categoryColors[activity.category]}"></div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 truncate">${activity.title}</h4>
                    <p class="text-sm text-gray-600 truncate">${activity.description || 'No description'}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ${new Date(activity.startDate).toLocaleDateString()}
                        ${activity.endDate && activity.endDate !== activity.startDate ? 
                            ` - ${new Date(activity.endDate).toLocaleDateString()}` : ''}
                    </p>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <div class="text-xs bg-gray-100 px-2 py-1 rounded-full capitalize">
                        ${activity.category}
                    </div>
                    <button onclick="removeActivity(${activity.id})" 
                        class="p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors"
                        title="Remove activity">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function openAddActivityModal(date = '') {
        const modal = document.getElementById('add-activity-modal');
        modal.classList.remove('hidden');
        
        if (date) {
            document.getElementById('activity-start-date').value = date;
            document.getElementById('activity-end-date').value = date;
        }
    }
    
    function closeModal() {
        document.getElementById('add-activity-modal').classList.add('hidden');
        document.getElementById('activity-form').reset();
    }
    
    async function removeActivity(activityId) {
        if (confirm('Are you sure you want to remove this activity?')) {
            const success = await deleteActivity(activityId);
            if (success) {
                renderCalendar();
                renderUpcomingActivities();
            }
        }
    }
    
    // Event listeners
    document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    document.getElementById('add-activity-btn').addEventListener('click', () => {
        openAddActivityModal();
    });
    
    document.getElementById('add-activity-btn-secondary').addEventListener('click', () => {
        openAddActivityModal();
    });
    
    document.getElementById('add-activity-btn-header').addEventListener('click', () => {
        openAddActivityModal();
    });
    
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('cancel-activity').addEventListener('click', closeModal);
    
    document.getElementById('activity-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newActivity = {
            title: document.getElementById('activity-title').value,
            description: document.getElementById('activity-description').value,
            startDate: document.getElementById('activity-start-date').value,
            endDate: document.getElementById('activity-end-date').value || document.getElementById('activity-start-date').value,
            category: document.getElementById('activity-category').value
        };
        
        const success = await saveActivity(newActivity);
        if (success) {
            renderCalendar();
            renderUpcomingActivities();
            closeModal();
        }
    });
    
    // Mobile menu toggle
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    });
    
    document.getElementById('overlay').addEventListener('click', () => {
        document.getElementById('sidebar').classles.add('-translate-x-full');
        document.getElementById('overlay').classList.add('hidden');
    });
    
    // Initialize calendar
    loadActivities();
</script>
</body>
</html>