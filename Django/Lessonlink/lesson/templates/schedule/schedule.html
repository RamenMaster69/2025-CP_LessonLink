<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LessonLink - Class Schedule</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script>
tailwind.config = {
    theme: {
        extend: {
            animation: {
                'fade-in': 'fadeIn 0.3s ease-in-out',
                'slide-in': 'slideIn 0.3s ease-out',
                'scale-in': 'scaleIn 0.2s ease-out',
                'bounce-in': 'bounceIn 0.4s ease-out',
                'slide-up': 'slideUp 0.3s ease-out'
            }
        }
    }
}
</script>
<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        transform: translateX(-100%);
    }

    to {
        transform: translateX(0);
    }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-10px);
    }

    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.98);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    position: relative;
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

.modal-option {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-option:hover {
    border-color: #9E5EFF;
    background-color: #f9f5ff;
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(158, 94, 255, 0.1);
}

.modal-option.selected {
    border-color: #9E5EFF;
    background-color: #f9f5ff;
}

.modal-option-icon {
    width: 3rem;
    height: 3rem;
    background: linear-gradient(135deg, #11468F, #9E5EFF);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.modal-option-icon i {
    color: white;
    font-size: 1.5rem;
}

.modal-option-text h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.modal-option-text p {
    font-size: 0.875rem;
    color: #6b7280;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.modal-btn {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-size: 0.875rem;
}

.modal-btn-primary {
    background: linear-gradient(135deg, #11468F, #9E5EFF);
    color: white;
}

.modal-btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.modal-btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.modal-btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.modal-btn-secondary:hover {
    background: #e5e7eb;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.2s ease;
}

.modal-close:hover {
    color: #374151;
}

.modal-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.modal-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
}

.modal-header p {
    color: #6b7280;
    font-size: 0.875rem;
}

/* Print Styles */
@media print {
    body * {
        visibility: hidden;
    }
    
    #printable-schedule,
    #printable-schedule * {
        visibility: visible;
    }
    
    #printable-schedule {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
        padding: 20px;
    }
    
    .no-print {
        display: none !important;
    }
    
    .schedule-item {
        break-inside: avoid;
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    
    .schedule-grid {
        border: 2px solid #000;
    }
    
    .time-column, .day-header {
        background-color: #f0f0f0 !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .schedule-item {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
    }
}

/* 
Z-INDEX HIERARCHY:
- Schedule items: 100 (normal), 200 (hover)
- Dropdowns: 50
- Sidebar/Overlay: 30-50
- Add Class Modal: 1000
- Confirmation/Error/Success Modals: 9999
- Toast Notifications: 9998
*/

.sidebar-transition {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.dropdown-enter {
    animation: scaleIn 0.2s ease-out;
}

.schedule-grid {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    gap: 0;
    position: relative;
}

@media (min-width: 768px) {
    .schedule-grid {
        grid-template-columns: 120px repeat(7, 1fr);
    }
}

.time-slot {
    min-height: 100px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
    background: white;
}

.schedule-item {
    position: absolute;
    color: white;
    border-radius: 6px;
    padding: 10px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
    z-index: 100;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    box-sizing: border-box;
    border: 2px solid rgba(255,255,255,0.4);
    left: 4px !important;
    right: 4px !important;
    width: calc(100% - 8px) !important;
}

.schedule-item:hover {
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    transform: translateY(-2px) scale(1.02);
    z-index: 200;
    border-color: rgba(255,255,255,0.6);
}

.schedule-item-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    gap: 4px;
}

.schedule-item-title {
    font-weight: 700;
    font-size: 14px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.schedule-item-time {
    font-size: 11px;
    opacity: 0.95;
    line-height: 1.2;
    font-weight: 500;
}

.schedule-item-instructor {
    font-size: 11px;
    opacity: 0.9;
    font-style: italic;
    line-height: 1.2;
}

.schedule-item-description {
    font-size: 10px;
    opacity: 0.85;
    line-height: 1.2;
    margin-top: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Mobile schedule view - IMPROVED */
.mobile-day-view {
    display: none;
}

@media (max-width: 767px) {
    .mobile-day-view {
        display: block;
    }
    
    .desktop-schedule {
        display: none;
    }
    
    .mobile-day-header {
        position: sticky;
        top: 56px;
        background: white;
        z-index: 10;
        padding: 12px 12px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .mobile-day-selector {
        display: flex;
        overflow-x: auto;
        padding-bottom: 8px;
        gap: 8px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .mobile-day-selector::-webkit-scrollbar {
        display: none;
    }
    
    .mobile-day-tab {
        flex: 0 0 auto;
        padding: 10px 20px;
        border-radius: 20px;
        background: #f3f4f6;
        color: #6b7280;
        font-weight: 500;
        white-space: nowrap;
        font-size: 14px;
        min-height: 44px;
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .mobile-day-tab.active {
        background: #11468F;
        color: white;
    }
    
    .mobile-time-slot {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        min-height: 60px;
    }
    
    .mobile-time-label {
        font-weight: 500;
        color: #11468F;
        margin-bottom: 8px;
        font-size: 14px;
    }
}

/* Improved modal for mobile - ENHANCED */
@media (max-width: 640px) {
    #add-class-modal {
        padding: 0 !important;
    }
    
    #add-class-modal > div {
        width: 100% !important;
        max-width: 100% !important;
        max-height: 100vh !important;
        height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }
    
    #add-class-modal .p-6 {
        padding: 16px !important;
    }
    
    /* Better touch targets for mobile */
    #add-class-modal input,
    #add-class-modal select,
    #add-class-modal textarea {
        min-height: 48px !important;
        font-size: 16px !important; /* Prevents zoom on iOS */
    }
    
    #add-class-modal button {
        min-height: 48px !important;
        font-size: 16px !important;
    }
    
    .color-option {
        width: 44px !important;
        height: 44px !important;
        margin: 4px !important;
    }
}

/* Custom Pop-up Styles */
.popup-modal {
    backdrop-filter: blur(4px);
    animation: fadeIn 0.3s ease-out;
}

.popup-content {
    animation: bounceIn 0.4s ease-out;
}

.notification-toast {
    animation: slideUp 0.3s ease-out;
}

/* Time column styling */
.time-column {
    background-color: #f9fafb;
    border-right: 2px solid #d1d5db;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    color: #11468F;
    padding: 8px;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    min-height: 100px;
}

.day-header {
    background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
    font-weight: 700;
    color: #11468F;
    text-align: center;
    padding: 16px 8px;
    border-bottom: 2px solid #d1d5db;
    border-right: 1px solid #e5e7eb;
    font-size: 13px;
    letter-spacing: 0.5px;
}

/* Scrollable schedule */
.schedule-container {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    overflow-x: auto;
}

/* Better schedule item sizing */
@media (max-width: 1024px) {
    .schedule-item-title {
        font-size: 12px;
    }
    .schedule-item-time,
    .schedule-item-instructor {
        font-size: 10px;
    }
    .schedule-item-description {
        font-size: 9px;
    }
}

/* Prevent text overflow */
.schedule-item {
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
}

/* Grid container improvements */
.schedule-grid {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    overflow: hidden;
}

/* Empty state styling */
.empty-schedule {
    grid-column: 2 / -1;
    padding: 40px;
    text-align: center;
    color: #6b7280;
}

/* Mobile-specific improvements */
@media (max-width: 767px) {
    body {
        font-size: 14px;
    }
    
    /* Better header spacing */
    header {
        height: 56px;
    }
    
    /* Adjust main content padding */
    main {
        padding-top: 56px !important;
    }
    
    /* Better button sizing */
    button, a.flex {
        min-height: 44px;
    }
    
    /* Sidebar improvements */
    aside {
        width: 280px;
        max-width: 85vw;
    }
    
    /* Toast positioning */
    #toast-container {
        top: 60px;
        right: 8px;
        left: 8px;
    }
    
    .notification-toast {
        max-width: 100%;
    }
}

/* Landscape mobile handling */
@media (max-width: 767px) and (orientation: landscape) {
    .mobile-day-header {
        top: 48px;
    }
    
    header {
        height: 48px;
    }
    
    main {
        padding-top: 48px !important;
    }
}

/* Touch-friendly spacing */
@media (hover: none) and (pointer: coarse) {
    button, a {
        padding-top: 12px;
        padding-bottom: 12px;
    }
}

/* Hidden class for role-based visibility */
.teacher-only {
    display: none;
}

.department-head-only {
    display: none;
}

/* Locked button styles */
.locked-button {
    position: relative;
    cursor: not-allowed !important;
    opacity: 0.6;
    pointer-events: none;
}

.locked-button .lock-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    color: white;
    font-size: 1.25rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.locked-button:hover .lock-overlay {
    opacity: 1;
}

.locked-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #ef4444;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    margin-bottom: 8px;
    z-index: 1000;
    display: none;
}

.locked-button:hover .locked-tooltip {
    display: block;
}
</style>
</head>

<body class="bg-gray-50">
<!-- Lesson Type Selection Modal -->
<div id="lessonModal" class="modal-overlay">
    <div class="modal-content relative">
        <button class="modal-close" onclick="closeLessonModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-header">
            <h2>Create New Lesson</h2>
            <p>Choose the type of lesson plan you want to create</p>
        </div>

        <div class="space-y-3">
            <!-- Daily Lesson Plan Option -->
            <div class="modal-option" data-type="daily" onclick="selectLessonType('daily')">
                <div class="modal-option-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="modal-option-text">
                    <h3>Daily Lesson Plan</h3>
                    <p>Create a detailed lesson plan for a single day</p>
                </div>
            </div>

            <!-- Weekly Lesson Plan Option -->
            <div class="modal-option" data-type="weekly" onclick="selectLessonType('weekly')">
                <div class="modal-option-icon">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="modal-option-text">
                    <h3>Weekly Lesson Plan</h3>
                    <p>Plan your lessons for an entire week</p>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn modal-btn-secondary" onclick="closeLessonModal()">
                Cancel
            </button>
            <button id="continueBtn" class="modal-btn modal-btn-primary" onclick="continueToLesson()" disabled>
                Continue
            </button>
        </div>
    </div>
</div>

<!-- Printable Schedule Container (Hidden normally) -->
<div id="printable-schedule" style="display: none;"></div>

<!-- Header -->
<header class="bg-white shadow-sm border-b fixed top-0 left-0 right-0 z-50">
<div class="flex items-center justify-between px-3 py-2 md:px-6 md:py-4">
    <!-- Mobile menu button -->
    <button id="mobile-menu-btn"
        class="md:hidden p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center">
        <i class="fas fa-bars text-lg"></i>
    </button>

    <!-- Logo -->
            <a href="{% url 'dashboard' %}"><div class="flex items-center space-x-3 flex-1 md:flex-none">
                {% if user_school and user_school.school_logo %}
                <div class="w-10 h-10 rounded-full overflow-hidden shadow-md">
                    <img src="{{ user_school.school_logo.url }}" 
                        alt="{{ user_school.school_name }}" 
                        class="w-full h-full object-cover"
                        onerror="this.onerror=null; this.parentElement.classList.add('bg-gradient-to-r', 'from-[#11468F]', 'to-[#9E5EFF]'); this.style.display='none';">
                </div>
                {% else %}
                <div class="w-10 h-10 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] rounded-full shadow-md"></div>
                {% endif %}
                
                <div class="hidden sm:block">
                    <h1 class="text-xl font-bold text-gray-900">LessonLink</h1>
                    <p class="text-sm text-gray-500 hidden lg:block">
                        {% if user_school %}
                            {{ user_school.school_name }}
                        {% else %}
                            {{ user.email|default:"LessonLink" }}
                        {% endif %}
                    </p>
                </div>
            </div></a>

    <!-- Right side actions -->
    <div class="flex items-center space-x-1 md:space-x-4">
        <!-- Print Button -->
        <button id="print-schedule-btn"
            class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
            title="Print Schedule">
            <i class="fas fa-print text-base md:text-lg"></i>
        </button>

        <!-- Notifications -->
        <div class="relative">
            <button id="notification-btn"
                class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center">
                <i class="fas fa-bell text-base md:text-lg"></i>
                <span id="notification-badge"
                    class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
            </button>

            <!-- Notifications Dropdown -->
            <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-lg border border-gray-200 hidden z-50">
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-900">Notifications</h3>
                        <button class="text-purple-600 text-sm hover:text-purple-700" onclick="markAllNotificationsAsRead()">
                            Mark all read
                        </button>
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <!-- Notifications will be loaded here dynamically -->
                </div>
                <div class="p-4 border-t border-gray-100">
                    <button class="w-full text-center text-purple-600 text-sm hover:text-purple-700 font-medium">
                        View all notifications
                    </button>
                </div>
            </div>
        </div>

        
        <!-- Profile -->
        <div class="relative">
            <!-- Profile Dropdown -->
            <div class="relative">
                <button id="profile-btn"
                    class="w-9 h-9 md:w-10 md:h-10 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors min-w-[44px] min-h-[44px]">
                    <!-- Profile image placeholder -->
                    <i class="fas fa-user text-gray-500" id="header-profile-icon"></i>
                </button>

                <!-- Profile Dropdown - Moved INSIDE the same relative container -->
                <div id="profile-dropdown" class="absolute right-0 mt-2 w-64 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-lg border border-gray-200 hidden z-50 dropdown-enter">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full overflow-hidden bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                                <i class="fas fa-user-tie text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">John Doe</p>
                                <p class="text-sm text-gray-500">Teacher</p>
                            </div>
                        </div>
                    </div>
                    <div class="py-2">
                        <a href="{% url 'profile' %}"
                                class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-user w-4"></i>
                                <span>My Profile</span>
                            </a>
                        
                        <hr class="my-2">
                        <a href="#"
                            class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 transition-colors min-h-[44px]">
                            <i class="fas fa-sign-out-alt w-4"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</header>

<div class="flex pt-14 md:pt-16">
<!-- Sidebar -->
<aside id="sidebar"
            class="w-64 bg-white shadow-lg h-screen fixed top-14 md:top-16 left-0 -translate-x-full md:translate-x-0 sidebar-transition z-30 overflow-y-auto">
            <nav class="p-4 space-y-2">
                <!-- Create Lesson Button - Role Based Locking -->
                <div id="create-lesson-container">
                    <!-- This will be dynamically controlled by JavaScript -->
                </div>

                <!-- Navigation Items -->
                <a href="{% url 'dashboard' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group min-h-[44px]">
                    <i class="fas fa-home text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{% url 'draft_list' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group min-h-[44px]">
                    <i class="fas fa-file-alt text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Drafts</span>
                </a>
                <a href="{% url 'task' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group min-h-[44px]">
                    <i class="fas fa-tasks text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Tasks</span>
                </a>
                <a href="{% url 'schedule' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-[#11468F] bg-[#f0f5ff] rounded-lg border border-[#d6e0ff] min-h-[44px]">
                    <i class="fas fa-clock text-lg w-5"></i>
                    <span>Schedule</span>
                </a>
                <a href="{% url 'dep_calendar' %}"
                    class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors group min-h-[44px]">
                    <i class="fas fa-calendar text-lg w-5 group-hover:text-[#11468F] transition-colors"></i>
                    <span>Calendar</span>
                </a>
                
                <!-- Teacher-only navigation items -->
                <div id="teacher-only-nav">
                    <a href="{% url 'teacher_student_list' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors min-h-[44px]">
                        <i class="fas fa-user-graduate text-lg w-5"></i>
                        <span>My Students</span>
                    </a>
                    <a href="{% url 'supervising_teacher_reviews' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-[#f0f5ff] rounded-lg transition-colors min-h-[44px]">
                        <i class="fas fa-clipboard-check text-lg w-5"></i>
                        <span>Student Lesson Reviews</span>
                    </a>
                </div>
            </nav>
        </aside>

<!-- Overlay for mobile -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

<!-- Main Content -->
<main class="flex-1 md:ml-64 p-3 md:p-6 min-h-screen">
    <!-- Header Section -->
    <div class="mb-4 md:mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
            <div class="mb-3 md:mb-0">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-1 md:mb-2">Class Schedule</h2>
                <p class="text-sm md:text-base text-gray-600">Manage your weekly class schedule (Working Hours: 6:00 AM - 7:00 PM)</p>
            </div>
            <div class="flex space-x-2">
                <button id="print-schedule-btn-mobile"
                    class="bg-gray-600 text-white px-5 py-3 rounded-lg hover:bg-gray-700 transition-all shadow-md flex items-center justify-center space-x-2 min-h-[48px] md:hidden">
                    <i class="fas fa-print"></i>
                    <span class="font-medium">Print</span>
                </button>
                <button id="add-class-btn"
                    class="bg-[#11468F] text-white px-5 py-3 rounded-lg hover:bg-[#0d3a7a] transition-all shadow-md flex items-center justify-center space-x-2 min-h-[48px] w-full md:w-auto">
                    <i class="fas fa-plus"></i>
                    <span class="font-medium">Add Class</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Desktop Schedule Grid (hidden on mobile) -->
    <div class="desktop-schedule bg-white rounded-xl shadow-sm p-4 mb-8 schedule-container">
        <div class="schedule-grid" id="schedule-grid">
            <!-- Time Column Header -->
            <div class="time-column rounded-tl-lg border-0"></div>
            <!-- Day Headers -->
            <div class="day-header">MONDAY</div>
            <div class="day-header">TUESDAY</div>
            <div class="day-header">WEDNESDAY</div>
            <div class="day-header">THURSDAY</div>
            <div class="day-header">FRIDAY</div>
            <div class="day-header">SATURDAY</div>
            <div class="day-header rounded-tr-lg border-r-0">SUNDAY</div>
            
            <!-- Time slots will be generated dynamically -->
        </div>
    </div>

    <!-- Mobile Schedule View (hidden on desktop) -->
    <div class="mobile-day-view bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="mobile-day-header">
            <div class="mobile-day-selector">
                <button class="mobile-day-tab active" data-day="monday">Monday</button>
                <button class="mobile-day-tab" data-day="tuesday">Tuesday</button>
                <button class="mobile-day-tab" data-day="wednesday">Wednesday</button>
                <button class="mobile-day-tab" data-day="thursday">Thursday</button>
                <button class="mobile-day-tab" data-day="friday">Friday</button>
                <button class="mobile-day-tab" data-day="saturday">Saturday</button>
                <button class="mobile-day-tab" data-day="sunday">Sunday</button>
            </div>
        </div>
        
        <div class="mobile-day-content">
            <!-- Time slots will be populated by JavaScript -->
        </div>
    </div>
</main>
</div>

<!-- Add Class Modal -->
<div id="add-class-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4 md:p-6 sticky top-0 bg-white z-10 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl md:text-2xl font-bold">Add Class</h2>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 min-w-[44px] min-h-[44px] flex items-center justify-center">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 md:p-6 pt-4">
                <form id="event-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Class Title</label>
                        <input type="text" id="event-title" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-gray-900 min-h-[48px] text-base" placeholder="e.g., System Integration">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Day</label>
                        <select id="event-day" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-gray-900 min-h-[48px] text-base">
                            <option value="">Select day</option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Start Time</label>
                            <input type="time" id="event-start" required 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-gray-900 min-h-[48px] text-base"
                                   min="06:00" max="19:00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">End Time</label>
                            <input type="time" id="event-end" required 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-gray-900 min-h-[48px] text-base"
                                   min="06:00" max="19:00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Instructor</label>
                        <input type="text" id="event-instructor" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-gray-900 min-h-[48px] text-base" placeholder="e.g., Sir Ceed">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Color</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-gray-900" data-color="#3b82f6"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-green-500" data-color="#10b981"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-purple-500" data-color="#8b5cf6"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-pink-500" data-color="#ec4899"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-yellow-500" data-color="#eab308"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-red-500" data-color="#ef4444"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-indigo-500" data-color="#6366f1"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-teal-500" data-color="#14b8a6"></button>
                            <button type="button" class="color-option w-11 h-11 md:w-10 md:h-10 rounded-full bg-amber-500" data-color="#f59e0b"></button>
                        </div>
                        <input type="hidden" id="event-color" value="#3b82f6">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Additional Notes (Optional)</label>
                        <textarea id="event-description" rows="3" class="w-full px-4 py-3 border rounded-lg resize-none text-base" placeholder="Optional notes or description"></textarea>
                    </div>
                    <div class="flex flex-col-reverse md:flex-row space-y-reverse space-y-3 md:space-y-0 md:space-x-3 pt-4">
                        <button type="button" id="cancel-btn" class="flex-1 px-6 py-3 border rounded-lg hover:bg-gray-50 min-h-[48px] font-medium">Cancel</button>
                        <button type="submit" class="flex-1 px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800 min-h-[48px] font-medium">Add Class</button>
                    </div>
                </form>
            </div>
</div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] hidden flex items-center justify-center p-4 popup-modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 popup-content">
        <div class="p-5 md:p-6 text-center">
            <div class="w-14 h-14 md:w-16 md:h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl md:text-2xl"></i>
            </div>
            <h3 class="text-base md:text-lg font-bold text-gray-900 mb-2">Remove Class</h3>
            <p class="text-sm md:text-base text-gray-600 mb-6">Are you sure you want to remove this class from your schedule?</p>
            
            <div class="flex flex-col-reverse md:flex-row space-y-reverse space-y-3 md:space-y-0 md:space-x-3">
                <button id="confirm-cancel" 
                    class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium min-h-[48px]">
                    Cancel
                </button>
                <button id="confirm-delete" 
                    class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium min-h-[48px]">
                    Remove
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="error-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] hidden flex items-center justify-center p-4 popup-modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 popup-content">
        <div class="p-5 md:p-6 text-center">
            <div class="w-14 h-14 md:w-16 md:h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-times-circle text-red-600 text-xl md:text-2xl"></i>
            </div>
            <h3 class="text-base md:text-lg font-bold text-gray-900 mb-2">Error</h3>
            <p id="error-message" class="text-sm md:text-base text-gray-600 mb-6">Something went wrong. Please try again.</p>
            
            <button id="error-ok" 
                class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium min-h-[48px]">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] hidden flex items-center justify-center p-4 popup-modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 popup-content">
        <div class="p-5 md:p-6 text-center">
            <div class="w-14 h-14 md:w-16 md:h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check-circle text-green-600 text-xl md:text-2xl"></i>
            </div>
            <h3 class="text-base md:text-lg font-bold text-gray-900 mb-2">Success!</h3>
            <p id="success-message" class="text-sm md:text-base text-gray-600 mb-6">Class has been added successfully.</p>
            
            <button id="success-ok" 
                class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium min-h-[48px]">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div id="validation-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9999] hidden flex items-center justify-center p-4 popup-modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 popup-content">
        <div class="p-5 md:p-6 text-center">
            <div class="w-14 h-14 md:w-16 md:h-16 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                <i class="fas fa-exclamation-circle text-yellow-600 text-xl md:text-2xl"></i>
            </div>
            <h3 class="text-base md:text-lg font-bold text-gray-900 mb-2">Validation Error</h3>
            <p id="validation-message" class="text-sm md:text-base text-gray-600 mb-6">Please fill in all required fields.</p>
            
            <button id="validation-ok" 
                class="w-full px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium min-h-[48px]">
                OK
            </button>
        </div>
</div>
</div>

<!-- Toast Notifications Container -->
<div id="toast-container" class="fixed top-16 md:top-20 right-4 z-[9998] space-y-2"></div>

<script>
// Get CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrfToken = getCookie('csrftoken');

// Store schedule data
let scheduleData = {};
let selectedColor = '#3b82f6'; // Default color

// Constants for schedule generation - IMPROVED FOR BETTER ALIGNMENT
const WORK_START_HOUR = 6; // 6:00 AM
const WORK_END_HOUR = 19; // 7:00 PM (24-hour format)
const TIME_SLOT_HEIGHT = 100; // Increased from 80 to 100px for better visibility
const MINUTES_PER_HOUR = 60;
const PIXELS_PER_MINUTE = TIME_SLOT_HEIGHT / MINUTES_PER_HOUR;

// Get user role and approval status from Django template
const userRole = "{{ user.role }}";
const userApprovalStatus = "{{ user.approval_status }}";

// ==================== LESSON MODAL FUNCTIONS ====================
let selectedLessonType = null;

// Open modal function
function openLessonModal() {
    const modal = document.getElementById('lessonModal');
    modal.classList.add('active');
    // Reset selection
    selectedLessonType = null;
    document.querySelectorAll('.modal-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.getElementById('continueBtn').disabled = true;
}

// Close modal function
function closeLessonModal() {
    const modal = document.getElementById('lessonModal');
    modal.classList.remove('active');
}

// Select lesson type
function selectLessonType(type) {
    selectedLessonType = type;
    
    // Update UI
    document.querySelectorAll('.modal-option').forEach(opt => {
        if (opt.getAttribute('data-type') === type) {
            opt.classList.add('selected');
        } else {
            opt.classList.remove('selected');
        }
    });
    
    // Enable continue button
    document.getElementById('continueBtn').disabled = false;
}

// Continue to selected lesson type
function continueToLesson() {
    if (!selectedLessonType) return;

    if (selectedLessonType === 'daily') {
        window.location.href = "{% url 'lesson_ai' %}";
    } else if (selectedLessonType === 'weekly') {
        window.location.href = "{% url 'lesson_ai_weekly' %}";
        closeLessonModal();
    }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('lessonModal');
    if (event.target === modal) {
        closeLessonModal();
    }
});

// ==================== PRINT FUNCTION ====================
function printSchedule() {
    // Create printable version
    const printableContainer = document.getElementById('printable-schedule');
    printableContainer.style.display = 'block';
    
    // Generate printable HTML
    let printableHTML = `
        <div style="font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #11468F; font-size: 28px; margin-bottom: 5px;">LessonLink</h1>
                <h2 style="color: #333; font-size: 22px;">Weekly Class Schedule</h2>
                <p style="color: #666;">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p style="color: #666;">Teacher: {{ user.first_name }} {{ user.last_name }}</p>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Time</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Monday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Tuesday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Wednesday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Thursday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Friday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Saturday</th>
                        <th style="border: 1px solid #ddd; padding: 12px; background-color: #f0f0f0; text-align: center;">Sunday</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Generate time slots
    for (let hour = WORK_START_HOUR; hour < WORK_END_HOUR; hour++) {
        const timeLabel = minutesToTime(hour * 60);
        printableHTML += `<tr>`;
        printableHTML += `<td style="border: 1px solid #ddd; padding: 10px; font-weight: bold; background-color: #f9f9f9;">${timeLabel}</td>`;
        
        // Add cells for each day
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        days.forEach(day => {
            printableHTML += `<td style="border: 1px solid #ddd; padding: 8px; vertical-align: top; min-height: 80px;">`;
            
            // Find events that fall within this hour
            const hourEvents = Object.values(scheduleData).filter(event => {
                if (event.day !== day) return false;
                const startHour = Math.floor(timeToMinutes(event.start_time) / 60);
                return startHour === hour;
            });
            
            hourEvents.forEach(event => {
                const startDisplay = formatTime24to12(event.start_time);
                const endDisplay = formatTime24to12(event.end_time);
                printableHTML += `
                    <div style="margin-bottom: 8px; padding: 5px; border-left: 4px solid ${event.color}; background-color: #f5f5f5;">
                        <strong>${event.title}</strong><br>
                        <small>${startDisplay} - ${endDisplay}</small><br>
                        <small>${event.instructor}</small>
                        ${event.description ? `<br><small style="color: #666;">${event.description}</small>` : ''}
                    </div>
                `;
            });
            
            printableHTML += `</td>`;
        });
        
        printableHTML += `</tr>`;
    }
    
    printableHTML += `
                </tbody>
            </table>
            <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                <p>Generated by LessonLink - Teacher Schedule Management System</p>
            </div>
        </div>
    `;
    
    printableContainer.innerHTML = printableHTML;
    
    // Trigger print
    window.print();
    
    // Hide printable container after printing
    setTimeout(() => {
        printableContainer.style.display = 'none';
        printableContainer.innerHTML = '';
    }, 1000);
}

// Role and approval-based button control
function setupCreateLessonButton() {
    const container = document.getElementById('create-lesson-container');
    
    if (!container) return;
    
    // Determine if button should be locked
    const isStudentTeacherNotApproved = (userRole === 'Student Teacher' && userApprovalStatus !== 'approved');
    const isOtherNotApproved = (userRole !== 'Student Teacher' && userRole !== 'Teacher' && userApprovalStatus !== 'approved');
    
    if (isStudentTeacherNotApproved || isOtherNotApproved) {
        // LOCKED VERSION - Student Teacher not approved
        let lockMessage = '';
        if (userRole === 'Student Teacher' && userApprovalStatus === 'pending') {
            lockMessage = 'Waiting for teacher approval';
        } else if (userRole === 'Student Teacher' && userApprovalStatus === 'disapproved') {
            lockMessage = 'Account disapproved by teacher';
        } else {
            lockMessage = 'Account not approved';
        }
        
        container.innerHTML = `
            <div class="relative locked-button mb-2">
                <button class="w-full flex items-center space-x-3 px-4 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-lg shadow-md min-h-[48px]" disabled>
                    <i class="fas fa-lock text-lg"></i>
                    <span class="font-medium">Create Lesson</span>
                </button>
                <div class="lock-overlay">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="locked-tooltip">${lockMessage}</div>
            </div>
        `;
    } else {
        // UNLOCKED VERSION - Using modal
        container.innerHTML = `
            <button onclick="openLessonModal()"
                    class="w-full flex items-center space-x-3 px-4 py-3 bg-gradient-to-r from-[#11468F] to-[#9E5EFF] text-white rounded-lg hover:from-[#0d3a7a] hover:to-[#8c4de6] transition-all shadow-md min-h-[48px]">
                <i class="fas fa-plus text-lg"></i>
                <span class="font-medium">Create Lesson</span>
            </button>
        `;
    }
}

// Role-based visibility control
function setRoleBasedVisibility() {
    const teacherOnlyNav = document.getElementById('teacher-only-nav');
    
    if (teacherOnlyNav) {
        if (userRole === 'Teacher') {
            // Show teacher-only items
            teacherOnlyNav.style.display = 'block';
        } else {
            // Hide teacher-only items for Student Teachers and Department Heads
            teacherOnlyNav.style.display = 'none';
        }
    }
}

// Modal and notification functions
function showConfirmation(message, onConfirm) {
    const modal = document.getElementById('confirmation-modal');
    const confirmBtn = document.getElementById('confirm-delete');
    const cancelBtn = document.getElementById('confirm-cancel');
    
    if (message) {
        modal.querySelector('p').textContent = message;
    }
    
    modal.classList.remove('hidden');
    
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    newConfirmBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        onConfirm();
    });
    
    newCancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });
}

function showError(message) {
    const modal = document.getElementById('error-modal');
    const errorMessage = document.getElementById('error-message');
    const okBtn = document.getElementById('error-ok');
    
    errorMessage.textContent = message;
    modal.classList.remove('hidden');
    
    okBtn.onclick = () => {
        modal.classList.add('hidden');
    };
}

function showSuccess(message) {
    const modal = document.getElementById('success-modal');
    const successMessage = document.getElementById('success-message');
    const okBtn = document.getElementById('success-ok');
    
    successMessage.textContent = message;
    modal.classList.remove('hidden');
    
    okBtn.onclick = () => {
        modal.classList.add('hidden');
    };
}

function showValidation(message) {
    const modal = document.getElementById('validation-modal');
    const validationMessage = document.getElementById('validation-message');
    const okBtn = document.getElementById('validation-ok');
    
    validationMessage.textContent = message;
    modal.classList.remove('hidden');
    
    okBtn.onclick = () => {
        modal.classList.add('hidden');
    };
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const icons = {
        success: 'fas fa-check-circle text-green-600',
        error: 'fas fa-times-circle text-red-600',
        warning: 'fas fa-exclamation-triangle text-yellow-600',
        info: 'fas fa-info-circle text-blue-600'
    };
    
    const colors = {
        success: 'bg-green-50 border-green-200',
        error: 'bg-red-50 border-red-200',
        warning: 'bg-yellow-50 border-yellow-200',
        info: 'bg-blue-50 border-blue-200'
    };
    
    toast.className = `notification-toast flex items-center p-3 md:p-4 mb-2 ${colors[type]} border rounded-lg shadow-lg max-w-sm`;
    toast.innerHTML = `
        <i class="${icons[type]} mr-3 flex-shrink-0"></i>
        <span class="text-xs md:text-sm font-medium text-gray-800 flex-1">${message}</span>
        <button class="ml-2 text-gray-400 hover:text-gray-600 min-w-[32px] min-h-[32px] flex items-center justify-center" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-10px)';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// DOM elements
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const notificationBtn = document.getElementById('notification-btn');
const notificationDropdown = document.getElementById('notification-dropdown');
const profileBtn = document.getElementById('profile-btn');
const profileDropdown = document.getElementById('profile-dropdown');
const addClassBtn = document.getElementById('add-class-btn');
const addClassModal = document.getElementById('add-class-modal');
const closeModal = document.getElementById('close-modal');
const cancelBtn = document.getElementById('cancel-btn');
const eventForm = document.getElementById('event-form');
const eventTitle = document.getElementById('event-title');
const eventDay = document.getElementById('event-day');
const eventStart = document.getElementById('event-start');
const eventEnd = document.getElementById('event-end');
const eventInstructor = document.getElementById('event-instructor');
const eventDescription = document.getElementById('event-description');
const colorOptions = document.querySelectorAll('.color-option');
const mobileDayTabs = document.querySelectorAll('.mobile-day-tab');
const scheduleGrid = document.getElementById('schedule-grid');
const printBtn = document.getElementById('print-schedule-btn');
const printBtnMobile = document.getElementById('print-schedule-btn-mobile');

// Initialize color selection
colorOptions.forEach(option => {
    option.addEventListener('click', function() {
        colorOptions.forEach(opt => {
            opt.classList.remove('ring-2', 'ring-gray-900', 'ring-offset-2');
        });
        
        this.classList.add('ring-2', 'ring-gray-900', 'ring-offset-2');
        selectedColor = this.dataset.color;
        document.getElementById('event-color').value = selectedColor;
    });
});

// Set default color as selected
colorOptions[0].classList.add('ring-2', 'ring-gray-900', 'ring-offset-2');
document.getElementById('event-color').value = selectedColor;

// Print button event listeners
if (printBtn) {
    printBtn.addEventListener('click', printSchedule);
}
if (printBtnMobile) {
    printBtnMobile.addEventListener('click', printSchedule);
}

// Mobile menu toggle
mobileMenuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
});

overlay.addEventListener('click', () => {
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
});

// Dropdown toggles
notificationBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationDropdown.classList.toggle('hidden');
    profileDropdown.classList.add('hidden');
});

profileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    profileDropdown.classList.toggle('hidden');
    notificationDropdown.classList.add('hidden');
});

// Close dropdowns when clicking outside
document.addEventListener('click', () => {
    notificationDropdown.classList.add('hidden');
    profileDropdown.classList.add('hidden');
});

// Modal controls
addClassBtn.addEventListener('click', () => {
    addClassModal.classList.remove('hidden');
    eventForm.reset();
    colorOptions.forEach(opt => {
        opt.classList.remove('ring-2', 'ring-gray-900', 'ring-offset-2');
    });
    colorOptions[0].classList.add('ring-2', 'ring-gray-900', 'ring-offset-2');
    selectedColor = '#3b82f6';
    document.getElementById('event-color').value = selectedColor;
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    if (currentHour < WORK_START_HOUR || currentHour >= WORK_END_HOUR) {
        eventStart.value = '06:00';
        eventEnd.value = '07:00';
    } else {
        eventStart.value = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
        const endHour = currentHour + 1;
        eventEnd.value = `${endHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
    }
});

closeModal.addEventListener('click', () => {
    addClassModal.classList.add('hidden');
    eventForm.reset();
});

cancelBtn.addEventListener('click', () => {
    addClassModal.classList.add('hidden');
    eventForm.reset();
});

// Close modal when clicking outside
addClassModal.addEventListener('click', (e) => {
    if (e.target === addClassModal) {
        addClassModal.classList.add('hidden');
        eventForm.reset();
    }
});

// Time conversion functions
function timeToMinutes(timeStr) {
    timeStr = timeStr.toString().trim();
    
    if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    const timeParts = timeStr.split(' ');
    let [hours, minutes] = timeParts[0].split(':').map(Number);
    
    if (timeParts.length > 1) {
        const ampm = timeParts[1].toUpperCase();
        if (ampm === 'PM' && hours < 12) hours += 12;
        if (ampm === 'AM' && hours === 12) hours = 0;
    }
    
    return hours * 60 + minutes;
}

function minutesToTime(minutes) {
    let hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    const ampm = hours >= 12 ? 'PM' : 'AM';
    
    hours = hours % 12;
    if (hours === 0) hours = 12;
    
    return `${hours}:${mins.toString().padStart(2, '0')} ${ampm}`;
}

function minutesToTime24(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}

function formatTime24to12(time24) {
    if (!time24) return '';
    const [hours, minutes] = time24.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    let hour12 = hours % 12;
    if (hour12 === 0) hour12 = 12;
    return `${hour12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

// Generate schedule grid
function generateScheduleGrid() {
    while (scheduleGrid.children.length > 8) {
        scheduleGrid.removeChild(scheduleGrid.lastChild);
    }
    
    for (let hour = WORK_START_HOUR; hour < WORK_END_HOUR; hour++) {
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-column';
        timeLabel.textContent = minutesToTime(hour * 60);
        scheduleGrid.appendChild(timeLabel);
        
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        days.forEach(day => {
            const cell = document.createElement('div');
            cell.className = 'time-slot';
            cell.dataset.day = day;
            cell.dataset.time = hour * 60;
            cell.dataset.hour = hour;
            scheduleGrid.appendChild(cell);
        });
    }
    
    document.querySelectorAll('.time-slot').forEach(cell => {
        cell.addEventListener('click', (e) => {
            if (e.target.closest('.schedule-item')) return;
            
            const day = cell.dataset.day;
            const startMinutes = parseInt(cell.dataset.time);
            const hour = parseInt(cell.dataset.hour);
            
            let endMinutes = startMinutes + 60;
            if (endMinutes > WORK_END_HOUR * 60) {
                endMinutes = WORK_END_HOUR * 60;
            }
            
            eventDay.value = day;
            eventStart.value = minutesToTime24(startMinutes);
            eventEnd.value = minutesToTime24(endMinutes);
            
            addClassModal.classList.remove('hidden');
        });
    });
}

// IMPROVED: Calculate event position with precise alignment
function calculateEventPosition(event) {
    // Use the 24-hour format times for accurate calculation
    const startMinutes = timeToMinutes(event.start_time);
    const endMinutes = timeToMinutes(event.end_time);
    const duration = endMinutes - startMinutes;
    
    // Calculate position from the start of the work day
    const minutesFromStart = startMinutes - (WORK_START_HOUR * 60);
    const top = minutesFromStart * PIXELS_PER_MINUTE;
    const height = duration * PIXELS_PER_MINUTE;
    
    console.log(`Position calc for "${event.title}": start=${event.start_time} (${startMinutes}min), end=${event.end_time} (${endMinutes}min), top=${top}px, height=${height}px`);
    
    return { top, height };
}

function checkTimeOverlap(day, startTime, endTime, excludeId = null) {
    const events = Object.values(scheduleData).filter(event => 
        event.day === day && (!excludeId || event.id !== excludeId)
    );
    
    const newStart = timeToMinutes(startTime);
    const newEnd = timeToMinutes(endTime);
    
    for (const event of events) {
        // Use the 24-hour format times for accurate comparison
        const eventStart = timeToMinutes(event.start_time);
        const eventEnd = timeToMinutes(event.end_time);
        
        if ((newStart < eventEnd && newEnd > eventStart)) {
            return event;
        }
    }
    
    return null;
}

function addEventToSchedule(eventData) {
    scheduleData[eventData.id] = eventData;
    updateScheduleDisplay();
}

function updateScheduleDisplay() {
    console.log('=== UPDATING SCHEDULE DISPLAY ===');
    console.log('Total events:', Object.values(scheduleData).length);
    
    document.querySelectorAll('.schedule-item').forEach(item => item.remove());
    
    const dayCells = {};
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    days.forEach(day => {
        dayCells[day] = document.querySelectorAll(`.time-slot[data-day="${day}"]`);
        console.log(`${day}: ${dayCells[day].length} time slots`);
    });
    
    Object.values(scheduleData).forEach(event => {
        console.log(`\nProcessing: ${event.title}`);
        console.log(`  Day: ${event.day}`);
        console.log(`  Time: ${event.start_time} - ${event.end_time}`);
        
        const { top, height } = calculateEventPosition(event);
        
        const dayIndex = days.indexOf(event.day);
        if (dayIndex === -1) return;
        
        // Use start_time (24-hour format) for accurate positioning
        const startMinutes = timeToMinutes(event.start_time);
        const startHour = Math.floor(startMinutes / 60);
        
        console.log(`  Start hour: ${startHour}, Hour diff from ${WORK_START_HOUR}: ${startHour - WORK_START_HOUR}`);
        
        if (startHour >= WORK_START_HOUR && startHour < WORK_END_HOUR) {
            const hourDiff = startHour - WORK_START_HOUR;
            
            if (hourDiff >= 0 && hourDiff < dayCells[event.day].length) {
                const targetCell = dayCells[event.day][hourDiff];
                
                // Calculate the position RELATIVE to the cell's hour
                const cellStartMinutes = (WORK_START_HOUR + hourDiff) * 60;
                const relativeTop = (startMinutes - cellStartMinutes) * PIXELS_PER_MINUTE;
                
                console.log(`  Cell starts at: ${cellStartMinutes} min, Relative top: ${relativeTop}px`);
                
                const displayStart = formatTime24to12(event.start_time);
                const displayEnd = formatTime24to12(event.end_time);
                
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                scheduleItem.dataset.id = event.id;
                scheduleItem.style.background = event.color;
                scheduleItem.style.top = `${relativeTop}px`; // Use relative position
                scheduleItem.style.height = `${Math.max(height, 60)}px`; // Minimum height for visibility
                
                // Dynamic font sizing based on height
                const titleSize = Math.max(11, Math.min(14, height / 8));
                const textSize = Math.max(9, Math.min(11, height / 10));
                
                scheduleItem.innerHTML = `
                    <div class="schedule-item-content">
                        <div class="schedule-item-title" style="font-size: ${titleSize}px;">${event.title}</div>
                        <div class="schedule-item-time" style="font-size: ${textSize}px;">${displayStart} - ${displayEnd}</div>
                        <div class="schedule-item-instructor" style="font-size: ${textSize}px;">${event.instructor}</div>
                        ${event.description && height > 80 ? `<div class="schedule-item-description" style="font-size: ${textSize - 1}px;">${event.description}</div>` : ''}
                    </div>
                `;
                
                scheduleItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmation(`Remove "${event.title}" from your schedule?`, () => {
                        deleteScheduleEvent(event.id);
                    });
                });
                
                targetCell.appendChild(scheduleItem);
                
                console.log(`   Added to cell ${hourDiff} with relative top=${relativeTop}px, height=${height}px`);
            } else {
                console.error(`   Hour diff ${hourDiff} out of range (0-${dayCells[event.day].length})`);
            }
        } else {
            console.error(`   Start hour ${startHour} outside work hours ${WORK_START_HOUR}-${WORK_END_HOUR}`);
        }
    });
    
    console.log('=== SCHEDULE DISPLAY UPDATED ===\n');
    
    const activeDay = document.querySelector('.mobile-day-tab.active')?.dataset.day;
    if (activeDay) {
        updateMobileDayView(activeDay);
    }
}

function updateMobileDayView(day) {
    const dayEvents = Object.values(scheduleData)
        .filter(event => event.day === day)
        .sort((a, b) => timeToMinutes(a.start_time) - timeToMinutes(b.start_time));
    
    let html = '';
    
    if (dayEvents.length === 0) {
        html = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-calendar-plus text-3xl mb-4"></i>
                <p>No classes scheduled for ${day.charAt(0).toUpperCase() + day.slice(1)}</p>
                <button class="mt-4 text-[#11468F] hover:text-[#0d3a7a] font-medium add-class-btn-mobile min-h-[44px]" data-day="${day}">
                    <i class="fas fa-plus mr-1"></i> Add a class
                </button>
            </div>
        `;
    } else {
        dayEvents.forEach(event => {
            const displayStart = formatTime24to12(event.start_time);
            const displayEnd = formatTime24to12(event.end_time);
            
            html += `
                <div class="mobile-time-slot border-b border-gray-200">
                    <div class="flex items-start gap-3">
                        <div class="w-3 h-3 rounded-full flex-shrink-0 mt-1" style="background-color: ${event.color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-900 text-base">${event.title}</div>
                            <div class="text-sm text-gray-600 mt-2 flex items-center">
                                <i class="fas fa-clock mr-2 flex-shrink-0"></i>
                                <span>${displayStart} - ${displayEnd}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1 flex items-center">
                                <i class="fas fa-chalkboard-teacher mr-2 flex-shrink-0"></i>
                                <span>${event.instructor}</span>
                            </div>
                            ${event.description ? `
                                <div class="text-sm text-gray-500 mt-2 flex items-start">
                                    <i class="fas fa-sticky-note mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span>${event.description}</span>
                                </div>
                            ` : ''}
                            <div class="mt-3">
                                <button class="text-red-600 text-sm hover:text-red-800 font-medium remove-class-btn min-h-[44px] inline-flex items-center" data-id="${event.id}">
                                    <i class="fas fa-trash mr-2"></i> Remove Class
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    document.querySelector('.mobile-day-content').innerHTML = html;
    
    document.querySelectorAll('.add-class-btn-mobile').forEach(btn => {
        btn.addEventListener('click', () => {
            eventDay.value = btn.dataset.day;
            addClassModal.classList.remove('hidden');
        });
    });
    
    document.querySelectorAll('.remove-class-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const eventId = btn.dataset.id;
            const event = scheduleData[eventId];
            if (event) {
                showConfirmation(`Remove "${event.title}" from your schedule?`, () => {
                    deleteScheduleEvent(event.id);
                });
            }
        });
    });
}

// ==================== API FUNCTIONS ====================

async function deleteScheduleEvent(eventId) {
    try {
        console.log('Deleting schedule with ID:', eventId);
        
        const response = await fetch(`/api/schedules/${eventId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        console.log('Delete response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Delete successful:', data);
            
            delete scheduleData[eventId];
            updateScheduleDisplay();
            showToast('Class removed successfully', 'success');
        } else {
            const errorData = await response.json();
            console.error('Delete failed:', errorData);
            showError(errorData.error || 'Failed to remove class. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Network error. Please check your connection and try again.');
    }
}

async function loadFromBackend() {
    try {
        console.log('Loading schedules from backend...');
        const response = await fetch('/api/schedules/all/');
        console.log('Load response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Loaded data:', data);
            
            if (data.schedules) {
                scheduleData = {};
                data.schedules.forEach(event => {
                    const displayStart = formatTime24to12(event.start_time);
                    const displayEnd = formatTime24to12(event.end_time);
                    
                    scheduleData[event.id] = {
                        id: event.id,
                        title: event.title,
                        day: event.day,
                        start: displayStart,
                        end: displayEnd,
                        start_time: event.start_time,
                        end_time: event.end_time,
                        instructor: event.instructor,
                        color: event.color,
                        description: event.description || ''
                    };
                });
                updateScheduleDisplay();
                showToast('Schedule loaded successfully', 'success');
            } else if (data.error) {
                console.error('Error in response:', data.error);
                showToast('Error loading schedule: ' + data.error, 'error');
            } else {
                console.error('No schedules field in response:', data);
                showToast('No schedule data found', 'warning');
            }
        } else {
            const errorData = await response.json();
            console.error('Failed to load:', errorData);
            showToast('Failed to load schedule data: ' + (errorData.error || response.statusText), 'error');
        }
    } catch (error) {
        console.error('Error loading from backend:', error);
        showToast('Failed to load schedule data: ' + error.message, 'error');
    }
}

// ==================== EVENT FORM SUBMISSION ====================

eventForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = eventTitle.value.trim();
    const day = eventDay.value;
    const startTime24 = eventStart.value;
    const endTime24 = eventEnd.value;
    const instructor = eventInstructor.value.trim();
    const description = eventDescription.value.trim();
    const color = document.getElementById('event-color').value;
    
    if (!title || !day || !startTime24 || !endTime24 || !instructor) {
        showValidation('Please fill in all required fields.');
        return;
    }
    
    const startTime12 = formatTime24to12(startTime24);
    const endTime12 = formatTime24to12(endTime24);
    
    const startMinutes = timeToMinutes(startTime24);
    const endMinutes = timeToMinutes(endTime24);
    
    if (startMinutes >= endMinutes) {
        showError('End time must be after start time.');
        return;
    }
    
    if (startMinutes < WORK_START_HOUR * 60 || endMinutes > WORK_END_HOUR * 60) {
        showError(`Classes must be scheduled between ${minutesToTime(WORK_START_HOUR * 60)} and ${minutesToTime(WORK_END_HOUR * 60)}`);
        return;
    }
    
    // Check overlap using 24-hour format
    const overlappingEvent = checkTimeOverlap(day, startTime24, endTime24);
    if (overlappingEvent) {
        showError(`Time overlaps with "${overlappingEvent.title}" (${formatTime24to12(overlappingEvent.start_time)} - ${formatTime24to12(overlappingEvent.end_time)})`);
        return;
    }
    
    try {
        const response = await fetch('/api/schedules/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                title: title,
                day: day,
                start_time: startTime24,
                end_time: endTime24,
                instructor: instructor,
                color: color,
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const displayStart = formatTime24to12(data.start_time);
            const displayEnd = formatTime24to12(data.end_time);
            
            scheduleData[data.id] = {
                id: data.id,
                title: data.title,
                day: data.day,
                start: displayStart,
                end: displayEnd,
                start_time: data.start_time,
                end_time: data.end_time,
                instructor: data.instructor,
                color: data.color,
                description: data.description || ''
            };
            
            updateScheduleDisplay();
            addClassModal.classList.add('hidden');
            eventForm.reset();
            
            colorOptions.forEach(opt => {
                opt.classList.remove('ring-2', 'ring-gray-900', 'ring-offset-2');
            });
            colorOptions[0].classList.add('ring-2', 'ring-gray-900', 'ring-offset-2');
            selectedColor = '#3b82f6';
            document.getElementById('event-color').value = selectedColor;
            
            showSuccess(`${title} has been added to your ${day} schedule.`);
            showToast('Class added successfully', 'success');
        } else {
            let errorMessage = 'Failed to add class. Please try again.';
            if (data.error) {
                errorMessage = data.error;
            } else if (data.errors) {
                errorMessage = data.errors;
            }
            showError(errorMessage);
        }
    } catch (error) {
        console.error('Error:', error);
        showError('Network error. Please check your connection and try again.');
    }
});

// ==================== MOBILE DAY TAB SWITCHING ====================

mobileDayTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        mobileDayTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        updateMobileDayView(tab.dataset.day);
    });
});

// ==================== INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', function() {
    generateScheduleGrid();
    loadFromBackend();
    updateMobileDayView('monday');
    setRoleBasedVisibility(); // Set role-based visibility on page load
    setupCreateLessonButton(); // Setup create lesson button with role-based locking
});

// Close modal with ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        addClassModal.classList.add('hidden');
        eventForm.reset();
        // Close lesson modal if open
        const lessonModal = document.getElementById('lessonModal');
        if (lessonModal && lessonModal.classList.contains('active')) {
            lessonModal.classList.remove('active');
        }
    }
});

// Close modals when clicking outside
document.addEventListener('click', (e) => {
    const modals = ['confirmation-modal', 'error-modal', 'success-modal', 'validation-modal', 'lessonModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
});

// Real-time validation for time inputs
eventStart.addEventListener('change', function() {
    const startValue = this.value;
    const endValue = eventEnd.value;
    
    if (startValue && endValue) {
        const startMinutes = timeToMinutes(startValue);
        const endMinutes = timeToMinutes(endValue);
        
        if (startMinutes >= endMinutes) {
            const [hours, minutes] = startValue.split(':').map(Number);
            let newEndHour = hours + 1;
            if (newEndHour > WORK_END_HOUR) newEndHour = WORK_END_HOUR;
            eventEnd.value = `${newEndHour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
    }
});

// Prevent double-tap zoom on iOS
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);
</script>
</body>
</html>